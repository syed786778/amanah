<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Amanah - Secure marriage profile photo sharing with OTP protection by Syed Rashad">
    <title>Amanah - Secure Photo Sharing</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-gradient-purple {
            background: linear-gradient(135deg, #a855f7, #9333ea);
            transition: all 0.3s ease;
        }
        .btn-gradient-purple:hover {
            background: linear-gradient(135deg, #9333ea, #7e22ce);
            transform: translateY(-1px);
        }
        
        .secure-image-container {
            position: relative;
            display: inline-block;
            -webkit-user-select: none;
            user-select: none;
        }
        .viewer-thumbnail {
            width: 100%;
            height: 200px;
            background-color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .viewer-thumbnail canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
            width: auto !important;
            height: auto !important;
        }

        .btn-disabled {
            background-color: #6b7280;
            cursor: not-allowed;
            opacity: 0.6;
            pointer-events: none;
        }

        .screenshot-block-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .screenshot-block-overlay.active {
            display: flex;
        }

        body {
            -webkit-user-select: none; 
            -moz-user-select: none; 
            -ms-user-select: none; 
            user-select: none;
            overflow-x: hidden;
        }
    </style>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YPHFTQYLE1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-YPHFTQYLE1');
    </script>
</head>
<body class="bg-gray-900 text-gray-200" oncopy="return false;" oncut="return false;">
    
    <div id="screenshot-block-overlay" class="screenshot-block-overlay">
        <svg class="w-24 h-24 text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <h2 class="text-2xl font-bold text-white mb-2">⚠️ Screenshot Detected</h2>
        <p class="text-gray-300 text-center px-4">Screenshots are prohibited. You will be logged out shortly.</p>
    </div>

    <div id="app"></div>
    
    <script>
        const SUPABASE_URL = 'https://imiljivxosyrcosznklh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltaWxqaXZ4b3N5cmNvc3pua2xoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMTIwOTcsImV4cCI6MjA3OTY4ODA5N30.TOgeuC3-RdG2ywIxDz2NWRhLHI4gxTkG4pilaZBqhso';
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let visibilityChangeCount = 0;
        let lastVisibilityChange = 0;
        let protectionActive = false;

        let state = {
            view: 'home',
            currentAlbum: null,
            uploaderInfo: { name: '', email: '' },
            photos: [],
            shareLink: '',
            otp: '',
            otpExpiry: null,
            viewerOtp: '',
            viewerName: '',
            albumIdToView: '',
            isVerified: false,
            loading: false,
            lightboxIndex: null,
            manageEmail: '',
            termsAccepted: false,
            screenshotAttempts: 0,
            rightClickAttempts: 0,
            showReportModal: false,
            reportReason: '',
            reportDetails: ''
        };
        
        function genOTP(){return Math.floor(100000+Math.random()*900000).toString()}
        function genAlbumId(){return'album_'+Math.random().toString(36).substr(2,9)}
        
        function formatTime(e){
            const r=e-Date.now();
            if(r<=0)return 'Expired';
            const t=Math.floor(r/36e5);
            const n=Math.floor(r%36e5/6e4);
            
            if (t > 0) {
                return `${t}h ${n}m`;
            } else if (n > 0) {
                return `${n}m`;
            } else {
                return 'less than 1m';
            }
        }
        
        function actionCard(title, color, svgPath, text, buttonText, action) {
            return `
                <div class="bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-700 hover:border-${color}-500 transition-all duration-300 flex flex-col">
                    <div class="flex items-start mb-4">
                        <svg class="w-8 h-8 text-${color}-400 mr-3 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">${svgPath}</svg>
                        <h3 class="text-xl font-bold text-white leading-tight">${title}</h3>
                    </div>
                    <div class="text-gray-400 space-y-2 mb-8 text-sm flex-grow">${text}</div>
                    <button onclick="${action}" class="w-full bg-${color}-600 text-white py-3 rounded-lg font-semibold transition-all duration-300 hover:bg-${color}-700">
                        ${buttonText}
                    </button>
                </div>
            `;
        }

        function nav(e){
            protectionActive=false;
            state.view=e;
            window.location.hash = e === 'home' ? '' : e;
            if(e==='home'||e==='upload'||e==='manage'||e==='viewer'){
                if(e === 'home' || e === 'upload' || e === 'viewer') {
                    state.photos=[];
                    state.uploaderInfo={name:'',email:''};
                    state.currentAlbum=null;
                }
                state.isVerified=false;
                state.viewerOtp='';
                state.viewerName='';
                state.albumIdToView='';
                state.lightboxIndex=null;
                state.screenshotAttempts=0;
                state.rightClickAttempts=0;
            }
            render()
        }
        
        function toggleTerms(checkbox) {
            state.termsAccepted = checkbox.checked;
            checkUploadFormComplete(); 
            render();
        }
        
        let uploadFormComplete = false;
        function checkUploadFormComplete() {
            const isComplete = !!state.uploaderInfo.name && !!state.uploaderInfo.email && state.photos.length > 0 && state.termsAccepted;
            if (isComplete !== uploadFormComplete) {
                uploadFormComplete = isComplete;
                render();
            }
        }
        
        function updateUploaderName(input) {
            state.uploaderInfo.name = input.value;
            checkUploadFormComplete();
        }

        function updateUploaderEmail(input) {
            state.uploaderInfo.email = input.value;
            checkUploadFormComplete();
        }

        let verifyFormComplete = false;
        function checkVerifyFormComplete() {
            const isComplete = !!state.albumIdToView && !!state.viewerOtp && state.viewerOtp.length === 6 && !!state.viewerName;
            if (isComplete !== verifyFormComplete) {
                verifyFormComplete = isComplete;
                render();
            }
            return isComplete;
        }

        function updateAlbumId(input) {
            const value = input.value.trim();
            const urlMatch = value.match(/album=(album_[a-z0-9]+)/);
            state.albumIdToView = urlMatch ? urlMatch[1] : value;
            checkVerifyFormComplete();
        }

        function updateViewerOtp(input) {
            state.viewerOtp = input.value;
            checkVerifyFormComplete();
        }
        
        function updateViewerName(input) {
            state.viewerName = input.value;
            checkVerifyFormComplete();
        }
        
        let manageFormComplete = false;
        function checkManageFormComplete() {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const isComplete = emailRegex.test(state.manageEmail);
            if (isComplete !== manageFormComplete) {
                manageFormComplete = isComplete;
                render();
            }
        }

        function updateManageEmail(input) {
            state.manageEmail = input.value;
            checkManageFormComplete();
        }

        function scrambleCanvasPixels(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.offsetWidth || 600; 
            const height = canvas.offsetHeight || 400;
            canvas.width = width;
            canvas.height = height;
            ctx.fillStyle = '#1f2937'; 
            ctx.fillRect(0, 0, width, height);
            ctx.save();
            ctx.fillStyle = 'rgba(255, 0, 0, 0.9)';
            ctx.font = 'bold 50px Arial'; 
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('ACCESS DENIED', width / 2, height / 2);
            ctx.restore();
        }

        function handleScreenshotAttempt() {
            const canvasElements = document.querySelectorAll('canvas[id^="secure-photo-"]');
            canvasElements.forEach(canvas => scrambleCanvasPixels(canvas.id));
            const overlay = document.getElementById('screenshot-block-overlay');
            if (overlay) {
                overlay.classList.add('active');
                setTimeout(() => {
                    overlay.classList.remove('active');
                    nav('home');
                }, 3000); 
            }
        }

        function showScreenshotWarning() {
            state.rightClickAttempts++;
            if (state.rightClickAttempts === 1) {
                alert('⚠️ WARNING: Screenshots and screen recording are strictly prohibited!\n\nThis action has been logged.');
            } else if (state.rightClickAttempts >= 2) {
                state.screenshotAttempts++;
                handleScreenshotAttempt();
            }
        }
        
        function setupProtection() {
            if (protectionActive) return;
            protectionActive = true;
            document.addEventListener('contextmenu', e => { e.preventDefault(); showScreenshotWarning(); });
            document.addEventListener('keydown', e => {
                if (e.key === 'PrintScreen' || (e.metaKey && e.shiftKey && (e.key === '3' || e.key === '4' || e.key === '5'))) {
                    e.preventDefault();
                    handleScreenshotAttempt();
                }
            });
        }
        
        function drawPhotoOnCanvas(canvasId, photoData, watermarkText) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                ctx.save();
                ctx.globalAlpha = 0.1;
                ctx.fillStyle = 'white';
                ctx.font = 'bold 40px Arial';
                ctx.textAlign = 'center';
                ctx.translate(canvas.width/2, canvas.height/2);
                ctx.rotate(-45 * Math.PI / 180);
                ctx.fillText(watermarkText || 'Amanah Secured', 0, 0);
                ctx.restore();
            };
            img.src = photoData;
        }

        async function verify(){
            if(!verifyFormComplete){alert('Please enter your Name, Album ID, and 6-digit OTP.');return}
            state.loading=true;render();
            try{
                const{data:e,error:t}=await supabaseClient.from('albums').select('*').eq('id',state.albumIdToView).single();
                if(t||!e){alert('Album not found.');state.loading=false;render();return}
                if(Date.now()>e.otp_expiry){alert('OTP expired.');state.loading=false;render();return}
                if(e.otp!==state.viewerOtp){alert('Invalid OTP.');state.loading=false;render();return}
                
                const{data:n,error:a}=await supabaseClient.from('photos').select('*').eq('album_id',state.albumIdToView).order('created_at',{ascending:true});
                if(a)throw a;
                
                // Records the name for the logs journey
                await supabaseClient.from('access_logs').insert({
                    album_id: state.albumIdToView,
                    viewer_name: state.viewerName.trim(),
                    accessed_at: new Date().toISOString()
                });
                
                state.currentAlbum={...e,photos:n.map(e=>e.photo_data)};
                state.isVerified=true;
                state.view='view';
                state.loading=false;
                render();
            }catch(err){
                console.error(err);
                state.loading=false;
                render();
            }
        }

        function render() {
            const app = document.getElementById('app');
            if (state.view === 'home') {
                app.innerHTML = `
                    <div class="max-w-6xl mx-auto px-4 py-12 text-center">
                        <h1 class="text-5xl font-extrabold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">AMANAH</h1>
                        <p class="text-gray-400 text-lg mb-12">Secure & Private Marriage Profile Photo Sharing</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                            ${actionCard('Create Secure Album', 'purple', '<path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>', 'Upload photos and protect them with an OTP and watermarks.', 'Create Secure Album', "nav('upload')")}
                            ${actionCard('View an Album', 'pink', '<path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>', 'Enter the Album ID and OTP shared with you to view photos.', 'View an Album', "nav('viewer')")}
                        </div>
                    </div>
                `;
            } else if (state.view === 'viewer') {
                app.innerHTML = `
                    <div class="max-w-md mx-auto mt-20 p-8 bg-gray-800 rounded-2xl border border-gray-700">
                        <h2 class="text-2xl font-bold mb-6">Enter Access Details</h2>
                        <div class="space-y-4">
                            <input type="text" placeholder="Your Full Name" oninput="updateViewerName(this)" value="${state.viewerName}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none">
                            <input type="text" placeholder="Album ID" oninput="updateAlbumId(this)" value="${state.albumIdToView}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none">
                            <input type="text" placeholder="6-digit OTP" oninput="updateViewerOtp(this)" value="${state.viewerOtp}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none">
                            <button onclick="verify()" class="w-full py-3 rounded-lg font-bold ${verifyFormComplete ? 'bg-purple-600' : 'bg-gray-600 pointer-events-none opacity-50'}">View Photos</button>
                        </div>
                    </div>
                `;
            } else if (state.view === 'view') {
                app.innerHTML = `
                    <div class="p-6 max-w-4xl mx-auto" id="viewer-content-area">
                        <h2 class="text-2xl font-bold mb-6">Protected Album: ${state.currentAlbum.name}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${state.currentAlbum.photos.map((p, i) => `
                                <div class="bg-gray-800 p-2 rounded-xl border border-gray-700">
                                    <canvas id="secure-photo-${i}" class="w-full rounded-lg"></canvas>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="nav('home')" class="mt-8 px-6 py-2 bg-gray-700 rounded-lg">Back to Home</button>
                    </div>
                `;
                state.currentAlbum.photos.forEach((p, i) => {
                    setTimeout(() => drawPhotoOnCanvas(`secure-photo-${i}`, p, state.viewerName), 100);
                });
                setTimeout(setupProtection, 200);
            } else {
                app.innerHTML = `<div class="p-12 text-center text-gray-500">Screen for "${state.view}" would go here.</div>`;
            }
        }

        window.onload = render;
    </script>
</body>
</html>
