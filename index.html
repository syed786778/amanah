<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Amanah - Secure marriage profile photo sharing with OTP protection by Syed Rashad">
    <title>Amanah - Secure Photo Sharing</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .btn-gradient-purple { background: linear-gradient(135deg, #a855f7, #9333ea); transition: all 0.3s ease; }
        .btn-gradient-purple:hover { background: linear-gradient(135deg, #9333ea, #7e22ce); transform: translateY(-1px); }
        .secure-image-container { position: relative; display: inline-block; -webkit-user-select: none; user-select: none; }
        .viewer-thumbnail { width: 100%; height: 240px; background-color: #1f2937; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 0.75rem; }
        .viewer-thumbnail canvas { max-width: 100%; max-height: 100%; object-fit: contain; width: auto !important; height: auto !important; }
        .btn-disabled { background-color: #6b7280; cursor: not-allowed; opacity: 0.6; pointer-events: none; }
        .screenshot-block-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .screenshot-block-overlay.active { display: flex; }
        body { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; overflow-x: hidden; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200" oncopy="return false;" oncut="return false;">
    
    <div id="screenshot-block-overlay" class="screenshot-block-overlay">
        <svg class="w-24 h-24 text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <h2 class="text-2xl font-bold text-white mb-2">‚ö†Ô∏è Screenshot Detected</h2>
        <p class="text-gray-300 text-center px-4">Screenshots are prohibited. You will be logged out shortly.</p>
    </div>

    <div id="app"></div>
    
    <script>
        const SUPABASE_URL = 'https://imiljivxosyrcosznklh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltaWxqaXZ4b3N5cmNvc3pua2xoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMTIwOTcsImV4cCI6MjA3OTY4ODA5N30.TOgeuC3-RdG2ywIxDz2NWRhLHI4gxTkG4pilaZBqhso';
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let visibilityChangeCount = 0;
        let lastVisibilityChange = 0;
        let protectionActive = false;

        let state = {
            view: 'home',
            currentAlbum: null,
            uploaderInfo: { name: '', email: '' },
            photos: [],
            shareLink: '',
            otp: '',
            otpExpiry: null,
            viewerOtp: '',
            albumIdToView: '',
            isVerified: false,
            loading: false,
            lightboxIndex: null,
            manageEmail: '',
            termsAccepted: false,
            screenshotAttempts: 0,
            rightClickAttempts: 0
        };

        // --- Helper Functions ---
        function genOTP(){return Math.floor(100000+Math.random()*900000).toString()}
        function genAlbumId(){return'album_'+Math.random().toString(36).substr(2,9)}
        function formatTime(e){
            const r=e-Date.now();
            if(r<=0)return 'Expired';
            const n=Math.floor(r%36e5/6e4);
            const t=Math.floor(r/36e5);
            return t > 0 ? `${t}h ${n}m` : `${n}m`;
        }

        // --- Routing and Navigation ---
        function nav(e){
            protectionActive = false;
            state.view = e;
            
            // Fix: Use query params for routing to avoid 404s on static hosts
            const newUrl = window.location.origin + window.location.pathname + (e === 'home' ? '' : `?page=${e}`);
            window.history.pushState({view: e}, document.title, newUrl);
            
            if(e==='home'||e==='upload'||e==='viewer'){
                state.isVerified=false;
                state.viewerOtp='';
                state.lightboxIndex=null;
            }
            render();
        }

        // --- Business Logic ---
        async function upload(){
            if (!state.termsAccepted || !state.photos.length) return;
            state.loading = true; render();
            try {
                const id = genAlbumId();
                const otp = genOTP();
                const expiry = Date.now() + 864e5;
                
                await supabaseClient.from('albums').insert({
                    id, name: state.uploaderInfo.name, 
                    email: state.uploaderInfo.email.trim().toLowerCase(), 
                    otp, otp_expiry: expiry, created_at: Date.now()
                });

                const photoInserts = state.photos.map(p => ({ album_id: id, photo_data: p }));
                await supabaseClient.from('photos').insert(photoInserts);

                state.currentAlbum = { id, name: state.uploaderInfo.name, photos: state.photos };
                state.otp = otp;
                state.otpExpiry = expiry;
                // FIX: Ensure share link points to root
                state.shareLink = window.location.origin + window.location.pathname + '?album=' + id;
                state.view = 'gallery';
            } catch (err) {
                alert("Upload failed: " + err.message);
            }
            state.loading = false; render();
        }

        async function verify(){
            state.loading = true; render();
            try {
                const { data: album } = await supabaseClient.from('albums').select('*').eq('id', state.albumIdToView).single();
                if (!album || album.otp !== state.viewerOtp || Date.now() > album.otp_expiry) {
                    throw new Error("Invalid or expired access details");
                }
                const { data: photos } = await supabaseClient.from('photos').select('photo_data').eq('album_id', state.albumIdToView);
                state.currentAlbum = { ...album, photos: photos.map(p => p.photo_data) };
                state.isVerified = true;
                state.view = 'view';
            } catch (err) {
                alert(err.message);
            }
            state.loading = false; render();
        }

        // --- Image Protection ---
        function drawPhotoOnCanvas(canvasId, photoData) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                // Watermark
                ctx.globalAlpha = 0.1;
                ctx.fillStyle = 'white';
                ctx.font = 'bold 40px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('AMANAH SECURE', canvas.width/2, canvas.height/2);
            };
            img.src = photoData;
        }

        // --- UI Rendering ---
        function render() {
            const app = document.getElementById('app');
            if (state.loading) {
                app.innerHTML = `<div class="flex items-center justify-center h-screen"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-purple-500"></div></div>`;
                return;
            }

            let content = '';
            switch(state.view) {
                case 'home':
                    content = `
                        <div class="max-w-4xl mx-auto px-4 py-12 text-center">
                            <h1 class="text-5xl font-extrabold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600">Amanah Photo Vault</h1>
                            <p class="text-xl text-gray-400 mb-10">Securely share marriage profile photos with time-limited OTP protection.</p>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div onclick="nav('upload')" class="p-8 bg-gray-800 rounded-2xl border border-gray-700 hover:border-purple-500 cursor-pointer transition-all">
                                    <h2 class="text-2xl font-bold mb-2">Create Album</h2>
                                    <p class="text-gray-400">Upload photos and generate a secure access link.</p>
                                </div>
                                <div onclick="nav('viewer')" class="p-8 bg-gray-800 rounded-2xl border border-gray-700 hover:border-pink-500 cursor-pointer transition-all">
                                    <h2 class="text-2xl font-bold mb-2">View Album</h2>
                                    <p class="text-gray-400">Enter an Album ID and OTP to view photos.</p>
                                </div>
                            </div>
                        </div>`;
                    break;
                
                case 'upload':
                    content = `
                        <div class="max-w-xl mx-auto p-6 bg-gray-800 rounded-2xl mt-10">
                            <h2 class="text-2xl font-bold mb-6">Create Secure Album</h2>
                            <input type="text" placeholder="Your Name" oninput="state.uploaderInfo.name=this.value" class="w-full p-3 mb-4 bg-gray-900 rounded-lg border border-gray-700">
                            <input type="email" placeholder="Your Email" oninput="state.uploaderInfo.email=this.value" class="w-full p-3 mb-4 bg-gray-900 rounded-lg border border-gray-700">
                            <input type="file" multiple accept="image/*" onchange="handleFiles(event)" class="mb-4 text-sm">
                            <div class="mb-4 text-sm text-gray-400">${state.photos.length} photos selected (Max 4)</div>
                            <label class="flex items-center mb-6 cursor-pointer">
                                <input type="checkbox" onchange="state.termsAccepted=this.checked; render();" class="mr-2">
                                <span class="text-xs">I agree photos will be shared securely and can be deleted anytime.</span>
                            </label>
                            <button onclick="upload()" class="w-full btn-gradient-purple py-3 rounded-lg font-bold ${(!state.termsAccepted || !state.photos.length) ? 'btn-disabled' : ''}">Generate Secure Link</button>
                        </div>`;
                    break;

                case 'gallery':
                    content = `
                        <div class="max-w-2xl mx-auto p-6 text-center">
                            <div class="bg-green-900/30 p-6 rounded-2xl border border-green-500 mb-6">
                                <h2 class="text-2xl font-bold text-green-400 mb-2">Album Created!</h2>
                                <p class="text-sm mb-4">Share the details below with the recipient.</p>
                                <div class="bg-black/40 p-4 rounded-lg text-left mb-4 break-all">
                                    <p><strong>Link:</strong> ${state.shareLink}</p>
                                    <p><strong>OTP:</strong> ${state.otp}</p>
                                    <p><strong>Expires:</strong> ${formatTime(state.otpExpiry)}</p>
                                </div>
                                <button onclick="navigator.clipboard.writeText('Link: ${state.shareLink}\\nOTP: ${state.otp}')" class="bg-white text-black px-4 py-2 rounded-lg text-sm font-bold">Copy Details</button>
                            </div>
                            <button onclick="nav('home')" class="text-purple-400 underline">Back to Home</button>
                        </div>`;
                    break;

                case 'viewer':
                    content = `
                        <div class="max-w-md mx-auto p-6 bg-gray-800 rounded-2xl mt-10">
                            <h2 class="text-2xl font-bold mb-6">Enter Access Details</h2>
                            <input type="text" placeholder="Album ID" value="${state.albumIdToView}" oninput="state.albumIdToView=this.value" class="w-full p-3 mb-4 bg-gray-900 rounded-lg border border-gray-700">
                            <input type="text" maxlength="6" placeholder="6-Digit OTP" oninput="state.viewerOtp=this.value" class="w-full p-3 mb-6 bg-gray-900 rounded-lg border border-gray-700 text-center tracking-widest text-xl">
                            <button onclick="verify()" class="w-full btn-gradient-purple py-3 rounded-lg font-bold">Unlock Photos</button>
                        </div>`;
                    break;

                case 'view':
                    content = `
                        <div class="max-w-5xl mx-auto p-6">
                            <div class="flex justify-between items-center mb-8">
                                <h2 class="text-2xl font-bold">Viewing Album: ${state.currentAlbum.name}</h2>
                                <div class="text-red-400 text-sm font-bold animate-pulse">üîí Protected Mode Active</div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-6" id="viewer-content-area">
                                ${state.currentAlbum.photos.map((p, i) => `
                                    <div class="viewer-thumbnail border border-gray-700">
                                        <canvas id="secure-photo-${i}"></canvas>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    setTimeout(() => {
                        state.currentAlbum.photos.forEach((p, i) => drawPhotoOnCanvas(`secure-photo-${i}`, p));
                        setupProtection();
                    }, 100);
                    break;
            }
            app.innerHTML = content;
        }

        function handleFiles(e){
            const files = Array.from(e.target.files).slice(0, 4);
            Promise.all(files.map(file => new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = (ev) => resolve(ev.target.result);
                reader.readAsDataURL(file);
            }))).then(res => { state.photos = res; render(); });
        }

        // --- Initialization Logic ---
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const albumId = urlParams.get('album');
            const page = urlParams.get('page');
            
            if (albumId) {
                state.view = 'viewer';
                state.albumIdToView = albumId;
            } else if (page) {
                state.view = page;
            }
            render();
        });

        // Ensure browser back button works
        window.onpopstate = (e) => {
            if (e.state && e.state.view) {
                state.view = e.state.view;
                render();
            }
        };

        // Reuse your setupProtection and handleScreenshotAttempt logic here...
        function setupProtection() {
            if (protectionActive) return;
            protectionActive = true;
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('keydown', e => {
                if (e.key === 'PrintScreen' || (e.ctrlKey && e.key === 'p')) {
                    e.preventDefault();
                    handleScreenshotAttempt();
                }
            });
        }

        function handleScreenshotAttempt() {
            const overlay = document.getElementById('screenshot-block-overlay');
            overlay.classList.add('active');
            setTimeout(() => {
                overlay.classList.remove('active');
                nav('home');
            }, 3000);
        }
    </script>
</body>
</html>
