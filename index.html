<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Amanah - Secure marriage profile photo sharing with OTP protection by Syed Rashad">
    <title>Amanah - Secure Photo Sharing</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-gradient-purple {
            background: linear-gradient(135deg, #a855f7, #9333ea);
            transition: all 0.3s ease;
        }
        .btn-gradient-purple:hover {
            background: linear-gradient(135deg, #9333ea, #7e22ce);
            transform: translateY(-1px);
        }
        
        .watermark-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
            max-height: 90vh;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-user-drag: none;
            cursor: default;
            -webkit-touch-callout: none;
        }

        .watermark-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            white-space: nowrap;
            font-size: 3vw;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.1);
            pointer-events: none;
            user-select: none;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        
        .btn-disabled {
            background-color: #6b7280;
            cursor: not-allowed;
            opacity: 0.6;
            pointer-events: none;
        }

        .copy-input {
            cursor: copy;
        }

        /* ENHANCED: Instant blackout overlay for screenshot attempts */
        .screenshot-block-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .screenshot-block-overlay.active {
            display: flex;
        }

        /* Prevent screenshot on some browsers */
        @media screen {
            .secure-content {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        }

        /* Additional iOS-specific protection for images */
        img.protected {
            -webkit-touch-callout: none;
            -webkit-user-select: none; /* Merged from second section */
            pointer-events: none;
        }
    </style>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YPHFTQYLE1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-YPHFTQYLE1');
    </script>
</head>
<body class="bg-gray-900 text-gray-200" oncopy="return false;" oncut="return false;">
    
    <div id="screenshot-block-overlay" class="screenshot-block-overlay">
        <svg class="w-24 h-24 text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <h2 class="text-2xl font-bold text-white mb-2">‚ö†Ô∏è Screenshot Detected</h2>
        <p class="text-gray-300 text-center px-4">Screenshots are prohibited. You will be redirected shortly.</p>
    </div>

    <div id="app"></div>
    
    <script>
        const SUPABASE_URL = 'https://imiljivxosyrcosznklh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltaWxqaXZ4b3N5cmNvc3pua2xoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMTIwOTcsImV4cCI6MjA3OTY4ODA5N30.TOgeuC3-RdG2ywIxDz2NWRhLHI4gxTkG4pilaZBqhso';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Screenshot detection variables (now global)
        let visibilityChangeCount = 0;
        let lastVisibilityChange = 0;
        let protectionActive = false;

        let state = {
            view: 'home',
            homeTab: 'upload', 
            currentAlbum: null,
            uploaderInfo: { name: '', email: '' },
            photos: [],
            shareLink: '',
            otp: '',
            otpExpiry: null,
            viewerOtp: '',
            albumIdToView: '',
            isVerified: false,
            loading: false,
            lightboxIndex: null,
            manageEmail: '',
            termsAccepted: false,
            screenshotAttempts: 0 // Track attempts for stronger action
        };
        
        function genOTP(){return Math.floor(100000+Math.random()*900000).toString()}
        function genAlbumId(){return'album_'+Math.random().toString(36).substr(2,9)}
        function formatTime(e){const r=e-Date.now(),t=Math.floor(r/36e5),n=Math.floor(r%36e5/6e4);return t+'h '+n+'m'}
        
        function actionCard(title, color, svgPath, text, buttonText, action) {
            return `
                <div class="bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-700 hover:border-${color}-500 transition-all duration-300">
                    <div class="flex items-center mb-4">
                        <svg class="w-8 h-8 text-${color}-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">${svgPath}</svg>
                        <h3 class="text-xl font-bold text-white">${title}</h3>
                    </div>
                    <div class="text-gray-400 space-y-2 mb-6 text-sm">${text}</div>
                    <button onclick="${action}" class="w-full bg-${color}-600 text-white py-3 rounded-lg font-semibold transition-all duration-300 hover:bg-${color}-700">
                        ${buttonText}
                    </button>
                </div>
            `;
        }

        function createShareMessage() {
            const albumName = state.currentAlbum ? state.currentAlbum.name : 'Secured Photos';
            const link = state.shareLink;
            const otp = state.otp;
            return `*--- Amanah Secure Photo Share ---*\nHello, here is the link to view the photo album for *${albumName}*.\n\nüîí *Album Access Details:*\n- *Share Link:* ${link}\n- *One-Time Passcode (OTP):* ${otp}\n\n*Instructions:* Tap the link, then enter the OTP to view the secured photos. The access is valid for 24 hours.\n\nRegards,\n${state.currentAlbum.name}`.trim();
        }

        function copyText() {
            navigator.clipboard.writeText(createShareMessage());
            alert('Shareable link & OTP copied to clipboard!');
        }
        
        function copyOtp() {
            navigator.clipboard.writeText(state.otp);
            alert('OTP copied to clipboard!');
        }

        function copyLink() {
            navigator.clipboard.writeText(state.shareLink);
            alert('Shareable link copied to clipboard!');
        }

        function shareViaWhatsApp() {
            const message = createShareMessage();
            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
        }

        /**
         * ENHANCED: Multi-layered screenshot protection for iOS and Android
         * This function is crucial for your requirement and has been fully integrated.
         */
        function setupProtection() {
            if (protectionActive) return;
            protectionActive = true;

            const viewerContent = document.getElementById('viewer-content-area');
            const overlay = document.getElementById('screenshot-block-overlay');
            if (!viewerContent || !overlay) return;

            console.log('üîí Enhanced protection activated');

            // 1. Desktop protection
            const contextMenuBlocker = e => { 
                e.preventDefault(); 
                showScreenshotWarning();
            };
            
            const keyBlocker = e => {
                // Block: F12, PrintScreen, Cmd+Shift+3/4/5 (Mac screenshots), Ctrl+P (print)
                if (e.keyCode === 123 || e.key === 'PrintScreen' || 
                    (e.metaKey && e.shiftKey && (e.key === '3' || e.key === '4' || e.key === '5')) ||
                    (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
                    (e.ctrlKey && e.key === 'p')) {
                    e.preventDefault();
                    showScreenshotWarning();
                }
            };
            
            document.addEventListener('contextmenu', contextMenuBlocker);
            document.addEventListener('keydown', keyBlocker);

            // 2. ENHANCED: Mobile Screenshot Detection via Visibility API
            const handleVisibilityChange = () => {
                const now = Date.now();
                const timeSinceLastChange = now - lastVisibilityChange;
                
                if (document.visibilityState === 'hidden') {
                    // Quick visibility changes (< 2 seconds) often indicate screenshot attempts
                    if (timeSinceLastChange < 2000) {
                        visibilityChangeCount++;
                        
                        // If multiple quick changes, likely a screenshot
                        if (visibilityChangeCount >= 2) {
                            handleScreenshotAttempt();
                        }
                    } else {
                        visibilityChangeCount = 1;
                    }
                    lastVisibilityChange = now;
                } else if (document.visibilityState === 'visible') {
                    // Reset counter after returning
                    setTimeout(() => {
                        if (visibilityChangeCount > 0) {
                            visibilityChangeCount = 0;
                        }
                    }, 3000);
                }
            };

            document.addEventListener('visibilitychange', handleVisibilityChange);

            // 3. ENHANCED: Page blur/focus detection (additional layer)
            let blurStartTime = 0;
            
            window.addEventListener('blur', () => {
                blurStartTime = Date.now();
            });

            window.addEventListener('focus', () => {
                if (blurStartTime > 0) {
                    const blurDuration = Date.now() - blurStartTime;
                    
                    // Very short blur (< 500ms) can indicate screenshot toolbar
                    if (blurDuration < 500 && blurDuration > 50) {
                        handleScreenshotAttempt();
                    }
                    blurStartTime = 0;
                }
            });

            // 4. iOS-specific: Detect screen recording API access
            if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                const originalGetDisplayMedia = navigator.mediaDevices.getDisplayMedia;
                navigator.mediaDevices.getDisplayMedia = function() {
                    handleScreenshotAttempt();
                    return originalGetDisplayMedia.apply(this, arguments);
                };
            }

            // 5. Prevent image drag/save on all images
            const imageElements = viewerContent.querySelectorAll('img');
            imageElements.forEach(img => {
                img.setAttribute('draggable', 'false');
                img.oncontextmenu = () => false;
                img.oncopy = () => false;
                img.oncut = () => false;
                img.ondragstart = () => false;
                img.style.userSelect = 'none';
                img.style.webkitUserSelect = 'none';
                img.style.webkitTouchCallout = 'none';
                img.classList.add('protected');
            });

            // 6. Monitor for suspicious activity patterns (long press on mobile)
            let touchHoldTimer;
            viewerContent.addEventListener('touchstart', (e) => {
                // Long press can be used for saving images on mobile
                touchHoldTimer = setTimeout(() => {
                    showScreenshotWarning();
                }, 500);
            });

            viewerContent.addEventListener('touchend', () => {
                clearTimeout(touchHoldTimer);
            });

            viewerContent.addEventListener('touchmove', () => {
                clearTimeout(touchHoldTimer);
            });
        }

        function handleScreenshotAttempt() {
            state.screenshotAttempts++;
            
            const overlay = document.getElementById('screenshot-block-overlay');
            if (overlay) {
                overlay.classList.add('active');
                
                // Log the attempt (you can send this to your backend)
                console.warn('Screenshot attempt detected:', {
                    album: state.currentAlbum?.id,
                    timestamp: new Date().toISOString(),
                    attemptNumber: state.screenshotAttempts
                });

                // Auto-redirect after 3 seconds
                setTimeout(() => {
                    nav('home');
                    alert('You have been logged out due to screenshot attempt. This incident has been logged.');
                }, 3000);
            }
        }

        function showScreenshotWarning() {
            alert('‚ö†Ô∏è Screenshots and screen recording are strictly prohibited!\n\nThis action has been logged and may result in restricted access.');
            state.screenshotAttempts++;
            
            if (state.screenshotAttempts >= 3) {
                handleScreenshotAttempt();
            }
        }
        
        function openLightbox(index){state.lightboxIndex=index;render();setTimeout(setupProtection,100);}
        function closeLightbox(){state.lightboxIndex=null;render();}
        function nextPhoto(){if(state.lightboxIndex<state.currentAlbum.photos.length-1){state.lightboxIndex++;render();setTimeout(setupProtection,100);}}
        function prevPhoto(){if(state.lightboxIndex>0){state.lightboxIndex--;render();setTimeout(setupProtection,100);}}
        function handleFiles(e){const t=Array.from(e.target.files);Promise.all(t.map(e=>new Promise(t=>{const n=new FileReader();n.onload=e=>t(e.target.result);n.readAsDataURL(e)}))).then(e=>{state.photos=[...state.photos,...e];render()})}
        function nav(e){protectionActive=false;state.view=e;if(e==='home'||e==='upload'||e==='manage'||e==='viewer'){state.photos=[];state.uploaderInfo={name:'',email:''};state.currentAlbum=null;state.isVerified=false;state.viewerOtp='';state.albumIdToView='';state.lightboxIndex=null;state.manageEmail='';state.screenshotAttempts=0;window.history.pushState({},document.title,location.pathname)}render()}
        function toggleTerms(checkbox) {
            state.termsAccepted = checkbox.checked;
            render();
        }

        async function manageAlbum(){ 
            if(!state.manageEmail){alert('Please enter your email');return}state.loading=true;render();try{const{data:albums,error}=await supabase.from('albums').select('*').eq('email',state.manageEmail.trim().toLowerCase());if(error)throw error;if(!albums||albums.length===0){alert('No albums found with this email address.');state.loading=false;render();return}const album=albums[0];const{data:photos}=await supabase.from('photos').select('*').eq('album_id',album.id).order('created_at',{ascending:true});state.currentAlbum={...album,photos:photos.map(p=>p.photo_data)};state.otp=album.otp;state.otpExpiry=album.otp_expiry;state.shareLink=location.origin+location.pathname+'?album='+album.id;state.view='gallery';state.loading=false;render()}catch(e){console.error('Manage error:',e);alert('Failed to load albums: '+e.message);state.loading=false;render()}}
        
        async function upload(){
            if (!state.termsAccepted) {
                alert('You must accept the Terms & Conditions before creating an album.');
                return;
            }
            if(!state.uploaderInfo.name||!state.uploaderInfo.email||!state.photos.length){alert('Please fill all required fields and upload at least one photo');return}state.loading=true;render();try{const e=genAlbumId(),t=genOTP(),n=Date.now()+864e5,{data:a,error:o}=await supabase.from('albums').insert({id:e,name:state.uploaderInfo.name,email:state.uploaderInfo.email.trim().toLowerCase(),otp:t,otp_expiry:n,created_at:Date.now()}).select().single();if(o)throw o;const{error:r}=await supabase.from('photos').insert(state.photos.map(t=>({album_id:e,photo_data:t})));if(r)throw r;const{data:s,error:i}=await supabase.from('photos').select('*').eq('album_id',e).order('created_at',{ascending:true});if(i)throw i;state.currentAlbum={...a,photos:s.map(e=>e.photo_data)};state.otp=t;state.otpExpiry=n;state.shareLink=location.origin+location.pathname+'?album='+e;state.view='gallery';state.loading=false;render()}catch(e){console.error('Upload error:',e);alert('Failed to create album: '+e.message);state.loading=false;render()}}

        async function regenOTP(){
            if(!state.currentAlbum)return;state.loading=true;render();try{const e=genOTP(),t=Date.now()+864e5,{error:n}=await supabase.from('albums').update({otp:e,otp_expiry:t}).eq('id',state.currentAlbum.id);if(n)throw n;state.currentAlbum.otp=e;state.otp=e;state.otpExpiry=t;state.loading=false;alert('New OTP generated successfully!');render()}catch(e){console.error('OTP error:',e);alert('Failed to regenerate OTP: '+e.message);state.loading=false;render()}}
        
        async function expireOTP(){
            if(!state.currentAlbum)return;if(!confirm('Expire OTP now? This will immediately block all access to your album.'))return;state.loading=true;render();try{const e=Date.now()-1000,{error:t}=await supabase.from('albums').update({otp_expiry:e}).eq('id',state.currentAlbum.id);if(t)throw t;state.currentAlbum.otp_expiry=e;state.otpExpiry=e;state.loading=false;alert('OTP expired successfully! No one can access this album now.');render()}catch(e){console.error('Expire OTP error:',e);alert('Failed to expire OTP: '+e.message);state.loading=false;render()}}
        
        async function verify(){
            if(!state.albumIdToView||!state.viewerOtp){alert('Please enter both Album ID and OTP');return}state.loading=true;render();try{const{data:e,error:t}=await supabase.from('albums').select('*').eq('id',state.albumIdToView).single();if(t||!e){alert('Album not found. Please check your Album ID.');state.loading=false;render();return}if(Date.now()>e.otp_expiry){alert('OTP has expired. Please contact the album owner to regenerate it.');state.loading=false;render();return}if(e.otp!==state.viewerOtp){alert('Invalid OTP. Please check and try again.');state.loading=false;render();return}const{data:n,error:a}=await supabase.from('photos').select('*').eq('album_id',state.albumIdToView).order('created_at',{ascending:true});if(a)throw a;state.currentAlbum={...e,photos:n.map(e=>e.photo_data)};state.isVerified=true;state.view='view';state.loading=false;render();setTimeout(setupProtection,100);}catch(e){console.error('Verify error:',e);alert('Failed to verify album: '+e.message);state.loading=false;render()}}
        
        async function delPhoto(e){
            if(!confirm('Are you sure you want to delete this photo?'))return;state.loading=true;render();try{const{data:t,error:n}=await supabase.from('photos').select('id').eq('album_id',state.currentAlbum.id).order('created_at',{ascending:true});if(n)throw n;if(t.length===1){if(confirm('This is the last photo. Delete the entire album?')){await delAlbum();return}else{state.loading=false;render();return}}const a=t[e],{error:o}=await supabase.from('photos').delete().eq('id',a.id);if(o)throw o;state.currentAlbum.photos=state.currentAlbum.photos.filter((t,n)=>n!==e);state.loading=false;alert('Photo deleted successfully');render()}catch(e){console.error('Delete error:',e);alert('Failed to delete photo: '+e.message);state.loading=false;render()}}
        
        async function delAlbum(){
            if(!confirm('Are you sure you want to delete this entire album? This action cannot be undone.'))return;state.loading=true;render();try{const{error:e}=await supabase.from('albums').delete().eq('id',state.currentAlbum.id);if(e)throw e;state.view='home';state.currentAlbum=null;state.loading=false;alert('Album deleted successfully');render()}catch(e){console.error('Delete error:',e);alert('Failed to delete album: '+e.message);state.loading=false;render()}}

        function renderFooter(){ 
            return `
                <footer class="bg-gray-900 border-t border-gray-700 text-gray-500 mt-16">
                    <div class="max-w-6xl mx-auto px-4 py-8">
                        <div class="grid md:grid-cols-4 gap-8">
                            <div class="md:col-span-2">
                                <h3 class="text-lg font-bold mb-4 text-purple-400 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    About Amanah
                                </h3>
                                <p class="text-sm text-gray-400 mb-3 leading-relaxed">
                                    Amanah was conceived by <strong>Syed Rashad</strong> out of a genuine need for digital security in sensitive, private matters like matrimonial profile sharing.
                                </p>
                                <p class="text-xs text-gray-500 leading-relaxed">
                                    Syed applies his operational expertise and commitment to excellent customer experience as a Senior Manager at a WealthTech firm.
                                </p>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold mb-4 text-purple-400">Legal & Security</h3>
                                <ul class="space-y-2 text-sm">
                                    <li class="text-red-400 font-semibold">‚ö†Ô∏è Cybercrime Warning</li>
                                    <li><a href="#" onclick="nav('terms'); return false;" class="text-purple-300 hover:text-purple-100 underline">Terms & Conditions</a></li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold mb-4 text-purple-400">Contact</h3>
                                <p class="text-sm text-gray-400 mb-2">Email:</p>
                                <a href="mailto:help.amanahapp@gmail.com" class="text-purple-300 hover:text-purple-100 text-sm underline">help.amanahapp@gmail.com</a>
                                <p class="text-sm text-gray-500 mt-4">¬© 2024 Amanah by Syed Rashad</p>
                            </div>
                        </div>
                        <div class="border-t border-gray-800 mt-6 pt-6 text-center text-xs text-gray-600">ÿ£ŸÖÿßŸÜÿ© - Trustworthy Protection</div>
                    </div>
                </footer>
            `;
        }

        function renderLoading(){ return '<div class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex flex-col items-center justify-center"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500"></div><span class="mt-4 text-xl font-semibold text-gray-300">Processing secure request...</span></div>';}

        function renderHomeView() {
            return `<div class="min-h-screen pt-12"><div class="max-w-6xl mx-auto px-4"><div class="text-center mb-16"><svg class="w-16 h-16 text-purple-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg><h1 class="text-5xl font-extrabold text-white mb-2 tracking-tight">Amanah</h1><p class="text-xl text-gray-400 mb-2">Secure, Controlled Photo Sharing for Matrimony</p><p class="text-md text-gray-500 max-w-2xl mx-auto">Created by <strong>Syed Rashad</strong> to protect personal photos in modern matchmaking with complete control and security.</p></div><div class="grid md:grid-cols-3 gap-8 mb-12">${actionCard('Upload Photos', 'purple', '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>', '<p>‚Ä¢ Enter details and upload photos</p><p>‚Ä¢ Get unique ID, OTP & link</p><p>‚Ä¢ Full control over access</p>', 'Start New Upload', 'nav(\'upload\')')}${actionCard('Manage Access', 'orange', '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>', '<p>‚Ä¢ Regenerate or expire OTP</p><p>‚Ä¢ Delete photos or the whole album</p><p>‚Ä¢ Requires your email address</p>', 'Manage Existing Album', 'nav(\'manage\')')}${actionCard('View Photos', 'green', '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>', '<p>‚Ä¢ Access a secured album</p><p>‚Ä¢ Requires Album ID and OTP</p><p>‚Ä¢ View on mobile and desktop</p>', 'View Shared Album', 'nav(\'viewer\')')}</div></div></div>${renderFooter()}`;
        }

        function renderUploadView() {
            const isUploadDisabled = !state.uploaderInfo.name || !state.uploaderInfo.email || state.photos.length === 0 || !state.termsAccepted;
            return `<div class="min-h-screen pt-12"><div class="max-w-4xl mx-auto px-4"><h2 class="text-3xl font-bold mb-8 text-white text-center">üîê Create Secured Photo Album</h2><div class="bg-gray-800 rounded-xl p-8 card-shadow border border-gray-700"><div class="mb-6"><label class="block text-gray-300 font-semibold mb-2" for="uploaderName">Your Name (for sharing)</label><input type="text" id="uploaderName" value="${state.uploaderInfo.name}" oninput="state.uploaderInfo.name=this.value;render()" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-purple-500 focus:border-purple-500" placeholder="e.g., Syed Rashad"></div><div class="mb-6"><label class="block text-gray-300 font-semibold mb-2" for="uploaderEmail">Your Email (for management)</label><input type="email" id="uploaderEmail" value="${state.uploaderInfo.email}" oninput="state.uploaderInfo.email=this.value;render()" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-purple-500 focus:border-purple-500" placeholder="your.email@example.com"></div><div class="mb-6"><label class="block text-gray-300 font-semibold mb-2">Upload Photos (Max 10)</label><div class="flex items-center justify-center w-full"><label for="photo-upload" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-600 border-dashed rounded-lg cursor-pointer bg-gray-700 hover:bg-gray-600"><div class="flex flex-col items-center justify-center pt-5 pb-6"><svg class="w-8 h-8 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v8"/></svg><p class="mb-2 text-sm text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p><p class="text-xs text-gray-500">PNG, JPG, HEIC (MAX. 10 photos)</p></div><input id="photo-upload" type="file" multiple accept="image/*" class="hidden" onchange="handleFiles(event)"> </label></div></div><div id="photo-preview" class="grid grid-cols-4 gap-4 mb-6"> ${state.photos.map((photo, index) => `<div class="relative"><img src="${photo}" class="w-full h-24 object-cover rounded-lg border border-gray-600"><button onclick="state.photos=state.photos.filter((p,i)=>i!==${index});render()" class="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 leading-none text-xs hover:bg-red-700 transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button></div>`).join('')}</div><div class="mb-6 flex items-start"><input id="terms-checkbox" type="checkbox" onchange="toggleTerms(this)" ${state.termsAccepted ? 'checked' : ''} class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500 mt-1"><label for="terms-checkbox" class="ml-2 text-sm font-medium text-gray-300"> I accept the <a href="#" onclick="nav('terms'); return false;" class="text-purple-400 hover:underline">Terms & Conditions</a>, confirming I have permission to share these photos and acknowledge the strict *NO SCREENSHOT* policy.</label></div><button onclick="upload()" class="w-full py-4 text-white rounded-lg font-bold ${isUploadDisabled ? 'btn-disabled' : 'btn-gradient-purple'}" ${isUploadDisabled ? 'disabled' : ''}>${state.loading?'<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white mx-auto"></div>':'Create Secured Album'}</button></div></div></div>${renderFooter()}`;
        }
        
        function renderManageView() {
            return `<div class="min-h-screen pt-12"><div class="max-w-md mx-auto px-4"><h2 class="text-3xl font-bold mb-8 text-white text-center">‚öôÔ∏è Manage Existing Album</h2><div class="bg-gray-800 rounded-xl p-8 card-shadow border border-gray-700"><p class="text-gray-400 mb-6 text-center">Enter the email you used to create the album to gain management access.</p><div class="mb-6"><label class="block text-gray-300 font-semibold mb-2" for="manageEmail">Your Email</label><input type="email" id="manageEmail" value="${state.manageEmail}" oninput="state.manageEmail=this.value;render()" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-purple-500 focus:border-purple-500" placeholder="your.email@example.com"></div><button onclick="manageAlbum()" class="w-full py-4 text-white rounded-lg font-bold ${state.manageEmail ? 'btn-gradient-purple' : 'btn-disabled'}" ${!state.manageEmail ? 'disabled' : ''}>${state.loading?'<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white mx-auto"></div>':'Access Management Dashboard'}</button></div></div></div>${renderFooter()}`;
        }
        
        function renderViewerView() {
            const isVerifyDisabled = !state.albumIdToView || !state.viewerOtp;
            return `<div class="min-h-screen pt-12"><div class="max-w-md mx-auto px-4"><h2 class="text-3xl font-bold mb-8 text-white text-center">üëÅÔ∏è View Secured Album</h2><div class="bg-gray-800 rounded-xl p-8 card-shadow border border-gray-700"><p class="text-gray-400 mb-6 text-center">Please enter the Album ID and One-Time Passcode (OTP) provided by the owner.</p><div class="mb-6"><label class="block text-gray-300 font-semibold mb-2" for="albumIdToView">Album ID</label><input type="text" id="albumIdToView" value="${state.albumIdToView}" oninput="state.albumIdToView=this.value;render()" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-purple-500 focus:border-purple-500" placeholder="e.g., album_f8y4x9z"></div><div class="mb-6"><label class="block text-gray-300 font-semibold mb-2" for="viewerOtp">OTP</label><input type="text" id="viewerOtp" value="${state.viewerOtp}" oninput="state.viewerOtp=this.value;render()" maxlength="6" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-purple-500 focus:border-purple-500" placeholder="e.g., 123456"></div><button onclick="verify()" class="w-full py-4 text-white rounded-lg font-bold ${isVerifyDisabled ? 'btn-disabled' : 'btn-gradient-purple'}" ${isVerifyDisabled ? 'disabled' : ''}>${state.loading?'<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white mx-auto"></div>':'Verify & View Photos'}</button></div></div></div>${renderFooter()}`;
        }
        
        function renderAlbumView() {
            if (!state.currentAlbum) return nav('home');
            const isManager = state.view === 'gallery';
            const album = state.currentAlbum;
            const otpExpired = Date.now() > album.otp_expiry;

            return `<div class="min-h-screen pt-12"><div class="max-w-6xl mx-auto px-4"><h2 class="text-3xl font-bold mb-2 text-white text-center">${isManager ? 'üì∏ Management Dashboard' : 'Secured Album'}</h2><p class="text-gray-400 text-center mb-10">Album for: <span class="font-semibold text-purple-400">${album.name}</span> (ID: <span class="font-mono text-sm text-gray-500">${album.id}</span>)</p>${isManager ? `<div class="bg-gray-800 rounded-xl p-6 card-shadow border border-gray-700 mb-8"><h3 class="text-xl font-bold text-white mb-4 flex items-center"><svg class="w-5 h-5 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Sharing & Control</h3><div class="grid md:grid-cols-2 gap-6"><div class="space-y-4"><p class="text-gray-300 text-sm font-semibold">Share Link:</p><div class="flex"><input type="text" value="${state.shareLink}" readonly onclick="copyLink()" class="copy-input flex-grow p-3 rounded-l-lg bg-gray-700 text-white border border-gray-600 text-sm overflow-hidden whitespace-nowrap text-ellipsis"><button onclick="copyLink()" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-r-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h6a2 2 0 012 2v10a2 2 0 01-2 2h-2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 16l-4-4m0 0l4-4m-4 4h12"/></svg></button></div></div><div class="space-y-4"><p class="text-gray-300 text-sm font-semibold">One-Time Passcode (OTP):</p><div class="flex"><input type="text" value="${state.otp}" readonly onclick="copyOtp()" class="copy-input flex-grow p-3 rounded-l-lg bg-gray-700 text-white border border-gray-600 text-sm"><button onclick="copyOtp()" class="bg-purple-600 hover:bg-purple-700 text-white p-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h6a2 2 0 012 2v10a2 2 0 01-2 2h-2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 16l-4-4m0 0l4-4m-4 4h12"/></svg></button><button onclick="regenOTP()" class="bg-orange-600 hover:bg-orange-700 text-white p-3 rounded-r-lg ml-1" title="Regenerate OTP"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.988 8.988 0 0112 21a9 9 0 01-8.638-3.957m-2.433-2.359a10 10 0 01-2.072-5.719"/></svg></button></div></div></div><div class="mt-6 flex items-center justify-between"><p class="text-sm ${otpExpired ? 'text-red-500 font-bold' : 'text-green-500'}">Status: ${otpExpired ? 'EXPIRED' : 'Active. Expires in ' + formatTime(album.otp_expiry)}</p><div class="space-x-3"><button onclick="expireOTP()" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold text-sm hover:bg-red-700 transition">Expire OTP Now</button><button onclick="delAlbum()" class="px-4 py-2 bg-red-800 text-white rounded-lg font-semibold text-sm hover:bg-red-900 transition">Delete Album</button></div></div></div>` : `<div class="bg-red-900 border border-red-700 text-red-300 p-4 rounded-lg mb-8 text-center"><p class="font-semibold text-lg">‚ö†Ô∏è STRICT POLICY: Screenshots are PROHIBITED.</p><p class="text-sm mt-1">This album is protected. Any attempt to screenshot or screen record will result in immediate session termination and logging of the incident.</p></div>`}<div id="viewer-content-area" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"> ${album.photos.map((photo, index) => `<div class="relative group cursor-pointer" onclick="openLightbox(${index})"><img src="${photo}" alt="Secured Photo ${index + 1}" class="w-full h-48 object-cover rounded-lg transition duration-300 group-hover:opacity-70 secure-content"><div class="watermark-overlay">${isManager ? 'MANAGE' : 'AMANAH'}</div>${isManager ? `<button onclick="event.stopPropagation();delPhoto(${index})" class="absolute top-2 right-2 bg-red-600 text-white rounded-full p-2 leading-none text-xs hover:bg-red-700 transition opacity-0 group-hover:opacity-100" title="Delete Photo"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>` : ''}</div>`).join('')}</div></div></div>${renderFooter()}`;
        }

        function renderLightbox() {
            if (state.lightboxIndex === null || !state.currentAlbum) return '';
            const photo = state.currentAlbum.photos[state.lightboxIndex];
            const isFirst = state.lightboxIndex === 0;
            const isLast = state.lightboxIndex === state.currentAlbum.photos.length - 1;
            const dynamicWatermarkText = `AMANAH - ID: ${state.currentAlbum.id} - ATTEMPT: ${state.screenshotAttempts}`;

            return `
                <div id="lightbox" class="fixed inset-0 bg-black bg-opacity-95 z-40 flex items-center justify-center p-4" onclick="closeLightbox()">
                    <button class="absolute top-4 right-4 text-white text-4xl p-2 z-50 hover:text-purple-400" onclick="closeLightbox()">&times;</button>
                    
                    <button onclick="event.stopPropagation(); prevPhoto()" class="absolute left-4 z-50 text-white text-5xl p-4 transition-opacity ${isFirst ? 'opacity-30 cursor-not-allowed' : 'hover:text-purple-400'}" ${isFirst ? 'disabled' : ''}>&#10094;</button>

                    <button onclick="event.stopPropagation(); nextPhoto()" class="absolute right-4 z-50 text-white text-5xl p-4 transition-opacity ${isLast ? 'opacity-30 cursor-not-allowed' : 'hover:text-purple-400'}" ${isLast ? 'disabled' : ''}>&#10095;</button>

                    <div id="viewer-content-area" class="watermark-container max-w-full max-h-[95vh] relative" onclick="event.stopPropagation()">
                        <img src="${photo}" class="secure-content protected max-h-[90vh] max-w-full object-contain rounded-lg border border-gray-700" alt="Secured Photo">
                        <div class="watermark-overlay" style="font-size: 5vw; opacity: 0.15; color: #a855f7;">${dynamicWatermarkText}</div>
                        
                        ${Array.from({ length: 4 }).map((_, i) => 
                            Array.from({ length: 4 }).map((_, j) => `
                                <div class="absolute text-xs font-mono text-gray-500 opacity-20 pointer-events-none user-select-none" 
                                    style="top: ${i * 25 + 10}%; left: ${j * 25 + 5}%; transform: rotate(15deg);">${state.currentAlbum.id}</div>
                            `).join('')
                        ).join('')}
                    </div>
                </div>
            `;
        }

        function renderTermsView() {
            return `<div class="min-h-screen pt-12"><div class="max-w-4xl mx-auto px-4"><h2 class="text-3xl font-bold mb-6 text-white text-center">üìú Amanah Terms & Conditions (Strict Policy)</h2><div class="bg-gray-800 rounded-xl p-8 card-shadow border border-gray-700"><div class="text-gray-300 space-y-6"><p class="text-xl font-bold text-red-500">SECTION 1: NO SCREENSHOTS, NO SCREEN RECORDING POLICY</p><ul class="list-disc list-inside space-y-2 ml-4 text-sm text-red-400"><li class="font-semibold"><strong>Zero Tolerance:</strong> The core security promise of Amanah is the prevention of unauthorized image saving and sharing. By using the viewer, you strictly agree NOT to capture, record, or duplicate the content displayed.</li><li><strong>Technical Deterrence:</strong> We employ multi-layered technical measures to detect and block screenshot attempts on both iOS and Android devices, as well as desktop browsers.</li><li><strong>Immediate Action:</strong> If a screenshot or screen recording attempt is detected, your session will be immediately terminated, your access will be revoked, and the incident (including your Album ID, IP address, and timestamp) will be permanently logged.</li><li><strong>Legal Warning:</strong> Unauthorized capture of private photos shared via Amanah may constitute a breach of trust and a violation of cyber security laws, for which the account creator/owner may pursue legal remedies.</li></ul><p class="text-xl font-bold mt-6 text-purple-500">SECTION 2: DATA & ACCESS CONTROL</p><ul class="list-disc list-inside space-y-2 ml-4 text-sm"><li class="font-semibold"><strong>OTP Protection:</strong> Access is controlled via a unique, single-use One-Time Passcode (OTP) valid for 24 hours. The album owner retains the right to regenerate or expire the OTP at any time.</li><li><strong>Data Deletion:</strong> The album owner is solely responsible for deleting photos and the album when they deem it appropriate.</li><li><strong>Email for Management:</strong> The email provided during upload is the sole key for management access (regenerating OTP, deleting content). Amanah does not store passwords.</li></ul><p class="text-xl font-bold mt-6 text-purple-500">SECTION 3: LIABILITY & DISCLAIMER</p><ul class="list-disc list-inside space-y-2 ml-4 text-sm"><li>Amanah provides security tools to *deter* and *detect* unauthorized access, but cannot guarantee 100% prevention against advanced screen capture methods or the 'analogue hole' (taking a picture of the screen with a second device).</li><li>Amanah and Syed Rashad are not liable for any misuse, unauthorized sharing, or legal consequences arising from a third party breaching this policy.</li><li>By uploading photos, you confirm you own the rights to the images and grant Amanah permission to securely host them for the purpose of sharing with your intended recipients.</li></ul></div><button onclick="nav('home')" class="w-full mt-8 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition">Return to Home</button></div></div></div>${renderFooter()}`;
        }
        
        function render() {
            const appDiv = document.getElementById('app');
            let content = '';

            // Render the main content based on the current view
            switch (state.view) {
                case 'home':
                    content = renderHomeView();
                    break;
                case 'upload':
                    content = renderUploadView();
                    break;
                case 'manage':
                    content = renderManageView();
                    break;
                case 'viewer':
                    content = renderViewerView();
                    break;
                case 'gallery':
                case 'view':
                    content = renderAlbumView();
                    break;
                case 'terms':
                    content = renderTermsView();
                    break;
                default:
                    content = renderHomeView();
            }

            // Add loading overlay if active
            if (state.loading) {
                content += renderLoading();
            }

            // Add lightbox if active
            if (state.lightboxIndex !== null) {
                content += renderLightbox();
            }

            appDiv.innerHTML = content;
        }

        // Initial render logic and URL parsing
        function initialize() {
            const urlParams = new URLSearchParams(window.location.search);
            const albumId = urlParams.get('album');
            
            if (albumId) {
                state.albumIdToView = albumId;
                state.view = 'viewer';
            }
            
            render();
        }

        initialize();
    </script>
</body>
</html>
