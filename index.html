<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Amanah - Secure marriage profile photo sharing with OTP protection by Syed Rashad">
    <title>Amanah - Secure Photo Sharing</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* ... (Existing styles like card-shadow, btn-gradient-purple, btn-disabled, etc. are retained) ... */
        
        /* NEW: Container to hold image and invisible overlay */
        .secure-image-container {
            position: relative;
            display: inline-block;
            /* Ensures no drag/select on the container itself */
            -webkit-user-select: none;
            user-select: none;
        }

        /* NEW: Canvas overlay to block direct access to the <img> element */
        .secure-canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Make it transparent but capture all mouse/touch events */
            background-color: transparent; 
            pointer-events: auto; /* IMPORTANT: Ensures this layer captures right-click/long-press */
            z-index: 5; /* Above the image, below the security watermark */
            cursor: default;
        }

        .watermark-overlay {
            /* Retained for text watermark, but now the image watermark is on the canvas */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            white-space: nowrap;
            font-size: 3vw;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.1);
            pointer-events: none;
            user-select: none;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        
        .screenshot-block-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .screenshot-block-overlay.active {
            display: flex;
        }

        /* HARDENED: Prevent standard browser selection/save functions */
        body {
            -webkit-user-select: none; 
            -moz-user-select: none; 
            -ms-user-select: none; 
            user-select: none;
        }
    </style>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YPHFTQYLE1"></script>
    <script>
        // ... (Google Analytics script is retained) ...
        // ... (State object is retained) ...
        // ... (Utility functions genOTP, genAlbumId, formatTime, actionCard are retained) ...
        // ... (Share/Copy functions are retained) ...
        
        const SUPABASE_URL = 'https://imiljivxosyrcosznklh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltaWxqaXZ4b3N5cmNvc3pua2xoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMTIwOTcsImV4cCI6MjA3OTY4ODA5N30.TOgeuC3-RdG2ywIxDz2NWRhLHI4gxTkG4pilaZBqhso';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let visibilityChangeCount = 0;
        let lastVisibilityChange = 0;
        let protectionActive = false;

        let state = {
            view: 'home',
            homeTab: 'upload', 
            currentAlbum: null,
            uploaderInfo: { name: '', email: '' },
            photos: [],
            shareLink: '',
            otp: '',
            otpExpiry: null,
            viewerOtp: '',
            albumIdToView: '',
            isVerified: false,
            loading: false,
            lightboxIndex: null,
            manageEmail: '',
            termsAccepted: false,
            screenshotAttempts: 0 
        };
        
        function genOTP(){return Math.floor(100000+Math.random()*900000).toString()}
        function genAlbumId(){return'album_'+Math.random().toString(36).substr(2,9)}
        function formatTime(e){const r=e-Date.now(),t=Math.floor(r/36e5),n=Math.floor(r%36e5/6e4);return t+'h '+n+'m'}
        
        // ... (actionCard, createShareMessage, copyText, copyOtp, copyLink, shareViaWhatsApp retained) ...
        
        /**
         * ENHANCED: Multi-layered screenshot protection for iOS and Android
         * Hardened: Added immediate redirection on first blur event for fast screenshot detection.
         */
        function setupProtection() {
            if (protectionActive) return;
            protectionActive = true;

            const viewerContent = document.getElementById('viewer-content-area');
            const overlay = document.getElementById('screenshot-block-overlay');
            if (!viewerContent || !overlay) return;

            console.log('ðŸ”’ Enhanced protection activated');

            // 1. Desktop protection (Retained)
            const contextMenuBlocker = e => { 
                e.preventDefault(); 
                showScreenshotWarning();
            };
            
            const keyBlocker = e => {
                // Block: F12, PrintScreen, Cmd+Shift+3/4/5 (Mac screenshots), Ctrl+P (print)
                if (e.keyCode === 123 || e.key === 'PrintScreen' || 
                    (e.metaKey && e.shiftKey && (e.key === '3' || e.key === '4' || e.key === '5')) ||
                    (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
                    (e.ctrlKey && e.key === 'p')) {
                    e.preventDefault();
                    handleScreenshotAttempt(); // Use immediate handle on hard attempts
                }
            };
            
            document.addEventListener('contextmenu', contextMenuBlocker);
            document.addEventListener('keydown', keyBlocker);

            // 2. Mobile Screenshot Detection via Visibility API (Retained, slightly less aggressive)
            const handleVisibilityChange = () => {
                const now = Date.now();
                const timeSinceLastChange = now - lastVisibilityChange;
                
                if (document.visibilityState === 'hidden') {
                    // Quick visibility change (< 1.5 seconds) often indicates screenshot attempts
                    if (timeSinceLastChange < 1500 && timeSinceLastChange > 50) { 
                        visibilityChangeCount++;
                        
                        if (visibilityChangeCount >= 2) {
                            handleScreenshotAttempt();
                        }
                    } else {
                        visibilityChangeCount = 1;
                    }
                    lastVisibilityChange = now;
                } else if (document.visibilityState === 'visible') {
                    // Reset counter only after a reasonable period
                    setTimeout(() => { visibilityChangeCount = 0; }, 3000); 
                }
            };

            document.addEventListener('visibilitychange', handleVisibilityChange);

            // 3. HARDENED: Page blur/focus detection (Most reliable mobile quick-block)
            let blurStartTime = 0;
            
            window.addEventListener('blur', () => {
                blurStartTime = Date.now();
            });

            window.addEventListener('focus', () => {
                if (blurStartTime > 0) {
                    const blurDuration = Date.now() - blurStartTime;
                    
                    // The key change: Very short blur (< 500ms) often means the screenshot UI popped up
                    if (blurDuration < 500 && blurDuration > 50) {
                        handleScreenshotAttempt(); // IMMEDIATE block
                    }
                    blurStartTime = 0;
                }
            });

            // 4. Prevent image drag/save/long-press on the invisible canvas overlay
            // This is handled by the canvas overlay element in the viewer render.
            // The canvas element itself has pointer-events: auto and oncontextmenu defined.
        }

        function handleScreenshotAttempt() {
            state.screenshotAttempts++;
            
            const overlay = document.getElementById('screenshot-block-overlay');
            if (overlay) {
                overlay.classList.add('active');
                
                console.warn('Screenshot attempt detected:', {
                    album: state.currentAlbum?.id,
                    timestamp: new Date().toISOString(),
                    attemptNumber: state.screenshotAttempts
                });

                // Immediate and aggressive logout
                setTimeout(() => {
                    nav('home');
                    alert('You have been logged out due to unauthorized screen capture attempt. This incident has been logged.');
                }, 1000); // Redirect faster (1 second)
            }
        }

        function showScreenshotWarning() {
            alert('âš ï¸ Screenshots and screen recording are strictly prohibited!\n\nThis action has been logged and may result in restricted access.');
            state.screenshotAttempts++;
            
            if (state.screenshotAttempts >= 2) { // Lowered threshold for aggressive block
                handleScreenshotAttempt();
            }
        }

        /**
         * NEW CORE FUNCTION: Draws the photo onto an HTML Canvas with a persistent watermark.
         * This prevents the browser from linking the image data to the standard save function.
         */
        function drawPhotoOnCanvas(canvasId, photoData, watermarkText) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = () => {
                // Set canvas size to match the image ratio
                const ratio = img.height / img.width;
                const canvasWidth = canvas.clientWidth;
                const canvasHeight = canvasWidth * ratio;
                
                // Ensure the canvas is sized to display correctly
                canvas.width = img.width;
                canvas.height = img.height;
                canvas.style.height = `${canvasHeight}px`;

                // 1. Draw the actual photo
                ctx.drawImage(img, 0, 0, img.width, img.height);
                
                // 2. Draw the UNREMOVABLE Watermark (Repeated for density)
                ctx.save();
                ctx.globalAlpha = 0.05; // Very subtle
                ctx.fillStyle = 'white';
                ctx.font = 'bold 150px Arial'; 
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const w = canvas.width;
                const h = canvas.height;
                const step = 250;
                
                // Repeated, diagonal watermark pattern
                for(let i = -w; i < w + h; i += step) {
                    for(let j = -h; j < h + w; j += step) {
                        ctx.save();
                        ctx.translate(i, j);
                        ctx.rotate(-45 * Math.PI / 180);
                        ctx.fillText(watermarkText || 'Amanah Secured', 0, 0);
                        ctx.restore();
                    }
                }
                ctx.restore();
            };
            img.src = photoData;
        }

        // ... (openLightbox, closeLightbox, nextPhoto, prevPhoto, handleFiles, nav, toggleTerms retained) ...
        // ... (manageAlbum, upload, regenOTP, expireOTP, verify, delPhoto, delAlbum retained) ...
        // ... (renderFooter, renderLoading, renderHomeView, renderUploadView, renderManageView retained) ...

        function renderTermsView() {
            // ... (Terms and Conditions view is retained) ...
        }

        function renderGalleryView() {
            // ... (Gallery view retained, but the image display will point to the new view function) ...
        }

        function renderViewerPhoto(photo, index) {
            const albumName = state.currentAlbum?.name || 'Secured Album';
            // The image is now displayed inside a CANVAS element, not a simple <img> tag.
            // A transparent CANVAS overlay sits on top of the image (or in this case, the main canvas).
            
            // To ensure the protection is set up, we call the canvas drawing function after rendering.
            setTimeout(() => {
                drawPhotoOnCanvas(`secure-photo-${index}`, photo, albumName);
            }, 0);

            return `
                <div class="secure-image-container mx-auto max-w-full h-auto max-h-[90vh] overflow-hidden rounded-xl">
                    <canvas 
                        id="secure-photo-${index}" 
                        class="w-full h-auto object-contain" 
                        oncontextmenu="return false;"
                        oncopy="return false;"
                        ondragstart="return false;"
                        draggable="false">
                    </canvas>
                    <div class="watermark-overlay">${albumName}</div>
                </div>
            `;
        }

        function renderViewerView() {
            if (!state.isVerified || !state.currentAlbum) {
                return renderVerifyView();
            }

            const currentPhoto = state.currentAlbum.photos[state.lightboxIndex !== null ? state.lightboxIndex : 0];

            return `
                <div class="min-h-screen flex flex-col justify-between pt-4 pb-8">
                    <div class="flex-grow flex flex-col items-center justify-center p-4">
                        <div id="viewer-content-area" class="w-full max-w-4xl mx-auto">
                            <div class="text-center mb-4">
                                <h2 class="text-3xl font-bold text-white mb-1">${state.currentAlbum.name}'s Photos</h2>
                                <p class="text-gray-400">Access verified. Strict *NO SCREENSHOT* policy enforced.</p>
                            </div>
                            
                            ${renderViewerPhoto(currentPhoto, state.lightboxIndex !== null ? state.lightboxIndex : 0)}
                        </div>
                    </div>
                    
                    <div class="mt-8 px-4 w-full flex justify-center space-x-4">
                        <button onclick="nav('home')" class="py-2 px-6 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition">
                            Exit & Log Out
                        </button>
                    </div>
                </div>
                ${renderFooter()}
            `;
        }
        
        function renderVerifyView() {
            // ... (Verify view content is retained) ...
        }

        function renderLightbox() {
            // ... (Lightbox is retained, ensuring it calls renderViewerPhoto) ...
        }
        
        function render() {
            const app = document.getElementById('app');
            let content = '';
            
            switch (state.view) {
                case 'home':
                    content = renderHomeView();
                    break;
                case 'upload':
                    content = renderUploadView();
                    break;
                case 'manage':
                    content = renderManageView();
                    break;
                case 'viewer':
                    content = renderVerifyView();
                    break;
                case 'view':
                    content = renderViewerView();
                    break;
                case 'gallery':
                    content = renderGalleryView();
                    break;
                case 'terms':
                    content = renderTermsView();
                    break;
                default:
                    content = renderHomeView();
            }
            
            app.innerHTML = content;
            
            // Re-apply protection when entering the secured view or lightbox
            if (state.view === 'view' || state.lightboxIndex !== null) {
                setTimeout(setupProtection, 100);
            }

            if (state.loading) {
                app.innerHTML += renderLoading();
            }
        }

        // ... (Initial load and URL check retained) ...
        render();
    </script>
</body>
</html>
