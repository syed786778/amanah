<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Amanah - Secure marriage profile photo sharing with OTP protection by Syed Rashad">
    <title>Amanah - Secure Photo Sharing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="app"></div>
    <script>

        const SUPABASE_URL = 'https://imiljivxosyrcosznklh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltaWxqaXZ4b3N5cmNvc3pua2xoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMTIwOTcsImV4cCI6MjA3OTY4ODA5N30.TOgeuC3-RdG2ywIxDz2NWRhLHI4gxTkG4pilaZBqhso';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let state = {
            view: 'home',
            currentAlbum: null,
            uploaderInfo: {name: '', email: ''},
            photos: [],
            shareLink: '',
            otp: '',
            otpExpiry: null,
            viewerOtp: '',
            albumIdToView: '',
            isVerified: false,
            loading: false,
            lightboxIndex: null,
            manageEmail: ''
        };
        
        function genOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        function genAlbumId() {
            return 'album_' + Math.random().toString(36).substr(2, 9);
        }
        
        function formatTime(expiry) {
            const remaining = expiry - Date.now();
            const hours = Math.floor(remaining / 3600000);
            const minutes = Math.floor((remaining % 3600000) / 60000);
            return hours + 'h ' + minutes + 'm';
        }
        
        function copyText(text) {
            navigator.clipboard.writeText(text);
            alert('Copied to clipboard!');
        }
        
        function setupProtection() {
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('keydown', e => {
                if (e.key === 'PrintScreen' || (e.metaKey && e.shiftKey)) {
                    e.preventDefault();
                }
            });
        }
        
        function openLightbox(index) {
            state.lightboxIndex = index;
            render();
        }
        
        function closeLightbox() {
            state.lightboxIndex = null;
            render();
        }
        
        function nextPhoto() {
            if (state.lightboxIndex < state.currentAlbum.photos.length - 1) {
                state.lightboxIndex++;
                render();
            }
        }
        
        function prevPhoto() {
            if (state.lightboxIndex > 0) {
                state.lightboxIndex--;
                render();
            }
        }
        
        async function manageAlbum() {
            if (!state.manageEmail) {
                alert('Please enter your email');
                return;
            }
            
            state.loading = true;
            render();
            
            try {
                const {data: albums, error} = await supabase
                    .from('albums')
                    .select('*')
                    .eq('email', state.manageEmail.trim().toLowerCase());
                
                if (error) throw error;
                
                if (!albums || albums.length === 0) {
                    alert('No albums found with this email address.');
                    state.loading = false;
                    render();
                    return;
                }
                
                const album = albums[0];
                const {data: photos} = await supabase
                    .from('photos')
                    .select('*')
                    .eq('album_id', album.id)
                    .order('created_at', {ascending: true});
                
                state.currentAlbum = {...album, photos: photos.map(p => p.photo_data)};
                state.otp = album.otp;
                state.otpExpiry = album.otp_expiry;
                state.shareLink = location.origin + location.pathname + '?album=' + album.id;
                state.view = 'gallery';
                state.loading = false;
                render();
            } catch (e) {
                alert('Failed to load albums: ' + e.message);
                state.loading = false;
                render();
            }
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            const albumId = new URLSearchParams(window.location.search).get('album');
            if (albumId) {
                state.albumIdToView = albumId;
                state.view = 'viewer';
            }
            render();
        });
        
        function handleFiles(event) {
            const files = Array.from(event.target.files);
            Promise.all(files.map(file => new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsDataURL(file);
            }))).then(dataUrls => {
                state.photos = [...state.photos, ...dataUrls];
                render();
            });
        }
        
        async function upload() {
            if (!state.uploaderInfo.name || !state.uploaderInfo.email || !state.photos.length) {
                alert('Please fill all required fields and upload at least one photo');
                return;
            }
            
            state.loading = true;
            render();
            
            try {
                const albumId = genAlbumId();
                const otp = genOTP();
                const expiry = Date.now() + 86400000;
                
                const {data: album} = await supabase
                    .from('albums')
                    .insert({
                        id: albumId,
                        name: state.uploaderInfo.name,
                        email: state.uploaderInfo.email.trim().toLowerCase(),
                        otp: otp,
                        otp_expiry: expiry,
                        created_at: Date.now()
                    })
                    .select()
                    .single();
                
                await supabase
                    .from('photos')
                    .insert(state.photos.map(photo => ({
                        album_id: albumId,
                        photo_data: photo
                    })));
                
                const {data: photos} = await supabase
                    .from('photos')
                    .select('*')
                    .eq('album_id', albumId);
                
                state.currentAlbum = {...album, photos: photos.map(p => p.photo_data)};
                state.otp = otp;
                state.otpExpiry = expiry;
                state.shareLink = location.origin + location.pathname + '?album=' + albumId;
                state.view = 'gallery';
                state.loading = false;
                render();
            } catch (e) {
                alert('Failed to create album: ' + e.message);
                state.loading = false;
                render();
            }
        }
        
        async function regenOTP() {
            if (!state.currentAlbum) return;
            
            state.loading = true;
            render();
            
            try {
                const newOtp = genOTP();
                const newExpiry = Date.now() + 86400000;
                
                await supabase
                    .from('albums')
                    .update({otp: newOtp, otp_expiry: newExpiry})
                    .eq('id', state.currentAlbum.id);
                
                state.otp = newOtp;
                state.otpExpiry = newExpiry;
                state.loading = false;
                alert('New OTP generated successfully!');
                render();
            } catch (e) {
                alert('Failed to regenerate OTP');
                state.loading = false;
                render();
            }
        }
        
        async function expireOTP() {
            if (!confirm('Expire OTP now? This will immediately block all access to your album.')) return;
            
            state.loading = true;
            render();
            
            try {
                const expiry = Date.now() - 1000;
                await supabase
                    .from('albums')
                    .update({otp_expiry: expiry})
                    .eq('id', state.currentAlbum.id);
                
                state.otpExpiry = expiry;
                state.loading = false;
                alert('OTP expired successfully!');
                render();
            } catch (e) {
                alert('Failed to expire OTP');
                state.loading = false;
                render();
            }
        }
        
        async function verify() {
            if (!state.albumIdToView || !state.viewerOtp) {
                alert('Please enter both Album ID and OTP');
                return;
            }
            
            state.loading = true;
            render();
            
            try {
                const {data: album} = await supabase
                    .from('albums')
                    .select('*')
                    .eq('id', state.albumIdToView)
                    .single();
                
                if (!album) {
                    alert('Album not found');
                    state.loading = false;
                    render();
                    return;
                }
                
                if (Date.now() > album.otp_expiry) {
                    alert('OTP has expired');
                    state.loading = false;
                    render();
                    return;
                }
                
                if (album.otp !== state.viewerOtp) {
                    alert('Invalid OTP');
                    state.loading = false;
                    render();
                    return;
                }
                
                const {data: photos} = await supabase
                    .from('photos')
                    .select('*')
                    .eq('album_id', state.albumIdToView)
                    .order('created_at', {ascending: true});
                
                state.currentAlbum = {...album, photos: photos.map(p => p.photo_data)};
                state.isVerified = true;
                state.view = 'view';
                state.loading = false;
                setupProtection();
                render();
            } catch (e) {
                alert('Failed to verify album');
                state.loading = false;
                render();
            }
        }
        
        async function delPhoto(index) {
            if (!confirm('Are you sure you want to delete this photo?')) return;
            
            state.loading = true;
            render();
            
            try {
                const {data: photos} = await supabase
                    .from('photos')
                    .select('id')
                    .eq('album_id', state.currentAlbum.id)
                    .order('created_at', {ascending: true});
                
                if (photos.length === 1) {
                    if (confirm('This is the last photo. Delete the entire album?')) {
                        await delAlbum();
                        return;
                    }
                    state.loading = false;
                    render();
                    return;
                }
                
                await supabase
                    .from('photos')
                    .delete()
                    .eq('id', photos[index].id);
                
                state.currentAlbum.photos = state.currentAlbum.photos.filter((_, i) => i !== index);
                state.loading = false;
                alert('Photo deleted successfully');
                render();
            } catch (e) {
                alert('Failed to delete photo');
                state.loading = false;
                render();
            }
        }
        
        async function delAlbum() {
            if (!confirm('Are you sure you want to delete this entire album? This action cannot be undone.')) return;
            
            state.loading = true;
            render();
            
            try {
                await supabase
                    .from('albums')
                    .delete()
                    .eq('id', state.currentAlbum.id);
                
                state.view = 'home';
                state.currentAlbum = null;
                state.loading = false;
                alert('Album deleted successfully');
                render();
            } catch (e) {
                alert('Failed to delete album');
                state.loading = false;
                render();
            }
        }
        
        function nav(view) {
            state.view = view;
            if (view === 'home') {
                state.photos = [];
                state.uploaderInfo = {name: '', email: ''};
                state.currentAlbum = null;
                state.isVerified = false;
                state.viewerOtp = '';
                state.albumIdToView = '';
                state.lightboxIndex = null;
                state.manageEmail = '';
                window.history.pushState({}, document.title, location.pathname);
            }
            render();
        }
        
        function render() {
            const app = document.getElementById('app');
            
            if (state.view === 'home') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50">
                        <div class="max-w-7xl mx-auto px-6 py-12">
                            <div class="text-center mb-16">
                                <svg class="w-20 h-20 text-purple-600 mx-auto mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                                <h1 class="text-6xl font-extrabold text-gray-900 mb-4">Amanah</h1>
                                <p class="text-2xl text-purple-600 font-semibold italic mb-6">أمانة - Trustworthy Protection</p>
                                <div class="max-w-3xl mx-auto space-y-3">
                                    <p class="text-lg text-gray-700 leading-relaxed">Secure marriage profile photo sharing with complete control. Born from the real need to protect personal photos in an era of digital misuse, Amanah gives you the power to share confidently while maintaining full ownership and security.</p>
                                    <p class="text-md text-gray-600">Created by <span class="font-semibold text-purple-700">Syed Rashad</span> to solve the challenges of sharing sensitive photos in modern matchmaking.</p>
                                </div>
                            </div>
                            
                            <div class="grid lg:grid-cols-3 gap-8 mb-16">
                                <div class="bg-white rounded-2xl shadow-xl p-8 border border-purple-100 hover:shadow-2xl transition-shadow">
                                    <div class="flex items-center mb-6">
                                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-4 mr-4">
                                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                            </svg>
                                        </div>
                                        <h2 class="text-2xl font-bold">Upload Photos</h2>
                                    </div>
                                    <div class="space-y-3 mb-8 text-sm">
                                        <p class="text-gray-700">• Enter name and email</p>
                                        <p class="text-gray-700">• Upload multiple photos</p>
                                        <p class="text-gray-700">• Get unique ID, OTP & link</p>
                                        <p class="text-gray-700">• Share with recipients</p>
                                        <p class="text-gray-700">• Manage access anytime</p>
                                    </div>
                                    <button onclick="nav('upload')" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all">Start Uploading</button>
                                </div>
                                
                                <div class="bg-white rounded-2xl shadow-xl p-8 border border-orange-100 hover:shadow-2xl transition-shadow">
                                    <div class="flex items-center mb-6">
                                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-4 mr-4">
                                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            </svg>
                                        </div>
                                        <h2 class="text-2xl font-bold">Manage Album</h2>
                                    </div>
                                    <div class="space-y-3 mb-8 text-sm">
                                        <p class="text-gray-700">• Enter your email</p>
                                        <p class="text-gray-700">• Access dashboard</p>
                                        <p class="text-gray-700">• Regenerate or expire OTP</p>
                                        <p class="text-gray-700">• Delete photos or album</p>
                                        <p class="text-gray-700">• Full control over content</p>
                                    </div>
                                    <button onclick="nav('manage')" class="w-full bg-gradient-to-r from-orange-600 to-orange-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all">Manage Album</button>
                                </div>
                                
                                <div class="bg-white rounded-2xl shadow-xl p-8 border border-pink-100 hover:shadow-2xl transition-shadow">
                                    <div class="flex items-center mb-6">
                                        <div class="bg-gradient-to-br from-pink-500 to-pink-600 rounded-2xl p-4 mr-4">
                                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                            </svg>
                                        </div>
                                        <h2 class="text-2xl font-bold">View Photos</h2>
                                    </div>
                                    <div class="space-y-3 mb-8 text-sm">
                                        <p class="text-gray-700">• Receive Album ID & OTP</p>
                                        <p class="text-gray-700">• Click shared link</p>
                                        <p class="text-gray-700">• Enter credentials</p>
                                        <p class="text-gray-700">• View with protection</p>
                                        <p class="text-gray-700"><strong class="text-red-600">• OTP expires in 24h</strong></p>
                                    </div>
                                    <button onclick="nav('viewer')" class="w-full bg-gradient-to-r from-pink-600 to-pink-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all">View with OTP</button>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-2xl shadow-xl p-10">
                                <h3 class="text-3xl font-bold mb-8 text-center">Why Choose Amanah?</h3>
                                <div class="grid md:grid-cols-4 gap-8 text-center">
                                    <div>
                                        <div class="bg-purple-100 rounded-2xl p-4 inline-block mb-4">
                                            <svg class="w-12 h-12 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                            </svg>
                                        </div>
                                        <h4 class="font-bold text-lg mb-2">OTP Security</h4>
                                        <p class="text-sm text-gray-600">24h expiring OTPs</p>
                                    </div>
                                    <div>
                                        <div class="bg-purple-100 rounded-2xl p-4 inline-block mb-4">
                                            <svg class="w-12 h-12 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                            </svg>
                                        </div>
                                        <h4 class="font-bold text-lg mb-2">Screenshot Block</h4>
                                        <p class="text-sm text-gray-600">Protection enabled</p>
                                    </div>
                                    <div>
                                        <div class="bg-purple-100 rounded-2xl p-4 inline-block mb-4">
                                            <svg class="w-12 h-12 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                                            </svg>
                                        </div>
                                        <h4 class="font-bold text-lg mb-2">Cloud Storage</h4>
                                        <p class="text-sm text-gray-600">Access anywhere</p>
                                    </div>
                                    <div>
                                        <div class="bg-purple-100 rounded-2xl p-4 inline-block mb-4">
                                            <svg class="w-12 h-12 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                            </svg>
                                        </div>
                                        <h4 class="font-bold text-lg mb-2">Owner Control</h4>
                                        <p class="text-sm text-gray-600">Full access control</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <footer class="bg-gradient-to-br from-gray-900 to-gray-800 text-white mt-16">
                            <div class="max-w-7xl mx-auto px-6 py-12">
                                <div class="grid md:grid-cols-3 gap-10">
                                    <div>
                                        <h3 class="text-xl font-bold mb-4 text-purple-400">About Amanah</h3>
                                        <p class="text-sm text-gray-300 leading-relaxed">Created by <strong>Syed Rashad</strong>, Amanah was born from personal experience with the challenges of sharing marriage profile photos in today's digital age. In an era where personal data misuse is rampant, Amanah ensures your precious moments remain protected.</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold mb-4 text-purple-400">Legal & Privacy</h3>
                                        <p class="text-xs text-gray-400"><strong class="text-red-400">⚠️ Warning:</strong> Unauthorized use is a criminal offense under IT Act 2000 (India), GDPR (EU), and similar laws worldwide.</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold mb-4 text-purple-400">Contact</h3>
                                        <p class="text-sm text-gray-300 mb-3">For questions or support:</p>
                                        <a href="mailto:help.amanahapp@gmail.com" class="text-purple-400 hover:text-purple-300 text-sm font-medium">help.amanahapp@gmail.com</a>
                                        <p class="text-sm text-gray-400 mt-6">© 2024 Amanah by Syed Rashad<br/>أمانة - Trustworthy Protection</p>
                                    </div>
                                </div>
                            </div>
                        </footer>
                    </div>
                `;
            } else if (state.view === 'upload') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 p-6">
                        <div class="max-w-2xl mx-auto">
                            <button onclick="nav('home')" class="mb-4 text-purple-600 hover:text-purple-700 font-semibold">← Back to Home</button>
                            <div class="bg-white rounded-2xl shadow-xl p-8">
                                <h2 class="text-3xl font-bold mb-6 text-center">Upload Your Photos</h2>
                                ${state.loading ? '<div class="flex justify-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div></div>' : `
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Your Name *</label>
                                            <input type="text" oninput="state.uploaderInfo.name=this.value" placeholder="Full name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-semibold mb-2">Your Email *</label>
                                            <input type="email" oninput="