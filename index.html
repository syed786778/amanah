<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Amanah - Secure marriage profile photo sharing with OTP protection by Syed Rashad">
    <title>Amanah - Secure Photo Sharing</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Define a refined shadow for the new card look */
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Refined, modern gradient button style for purple (Standard Template Color) */
        .btn-gradient-purple {
            background: linear-gradient(135deg, #a855f7, #9333ea);
            transition: all 0.3s ease;
        }
        .btn-gradient-purple:hover {
            background: linear-gradient(135deg, #9333ea, #7e22ce);
            transform: translateY(-1px);
        }
        
        /* Watermark Container Style */
        .watermark-container {
            position: relative;
            display: inline-block; /* Essential to wrap the image */
            max-width: 100%;
            max-height: 90vh;
        }

        /* Watermark Overlay Style */
        .watermark-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            white-space: nowrap;
            font-size: 3vw; /* Responsive font size */
            font-weight: bold;
            color: rgba(255, 255, 255, 0.1); /* Lighter tone, very subtle white */
            pointer-events: none; /* Allows clicks to pass through */
            user-select: none;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        
        /* Disable button style */
        .btn-disabled {
            background-color: #6b7280; /* Gray-500 */
            cursor: not-allowed;
            opacity: 0.6;
            pointer-events: none;
        }

        /* Styling for the copy input fields */
        .copy-input {
            cursor: copy;
        }
    </style>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YPHFTQYLE1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YPHFTQYLE1');
    </script>
</head>
<body class="bg-gray-900 text-gray-200">
    <div id="app"></div>
    <script>
        
        const SUPABASE_URL = 'https://imiljivxosyrcosznklh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltaWxqaXZ4b3N5cmNvc3pua2xoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMTIwOTcsImV4cCI6MjA3OTY4ODA5N30.TOgeuC3-RdG2ywIxDz2NWRhLHI4gxTkG4pilaZBqhso';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let state = {
            view: 'home',
            homeTab: 'upload', 
            currentAlbum: null,
            uploaderInfo: { name: '', email: '' },
            photos: [],
            shareLink: '',
            otp: '',
            otpExpiry: null,
            viewerOtp: '',
            albumIdToView: '',
            isVerified: false,
            loading: false,
            lightboxIndex: null,
            manageEmail: '',
            // T&C acceptance
            termsAccepted: false
        };
        
        // --- Helper Functions (Updated) ---
        function genOTP(){return Math.floor(100000+Math.random()*900000).toString()}
        function genAlbumId(){return'album_'+Math.random().toString(36).substr(2,9)}
        function formatTime(e){const r=e-Date.now(),t=Math.floor(r/36e5),n=Math.floor(r%36e5/6e4);return t+'h '+n+'m'}
        
        // **NEW/UPDATED**: Create a formatted message for sharing
        function createShareMessage() {
            const albumName = state.currentAlbum ? state.currentAlbum.name : 'Secured Photos';
            const link = state.shareLink;
            const otp = state.otp;
            const message = `
*--- Amanah Secure Photo Share ---*
Hello, here is the link to view the photo album for *${albumName}*.

üîí *Album Access Details:*
- *Share Link:* ${link}
- *One-Time Passcode (OTP):* ${otp}

*Instructions:* Tap the link, then enter the OTP to view the secured photos. The access is valid for 24 hours.

Regards,
${state.currentAlbum.name}
            `.trim();
            return message;
        }

        // **UPDATED**: Copy function to use the new message
        function copyText() {
            const textToCopy = createShareMessage();
            navigator.clipboard.writeText(textToCopy);
            alert('Shareable link & OTP copied to clipboard!');
        }
        
        // **NEW**: Copy only OTP
        function copyOtp() {
            navigator.clipboard.writeText(state.otp);
            alert('OTP copied to clipboard!');
        }

        // **NEW**: Copy only Link
        function copyLink() {
            navigator.clipboard.writeText(state.shareLink);
            alert('Shareable link copied to clipboard!');
        }


        // **NEW**: WhatsApp Share Function
        function shareViaWhatsApp() {
            const message = createShareMessage();
            // Encode the message for the URL
            const encodedMessage = encodeURIComponent(message);
            // Use the WhatsApp API link (works on desktop and mobile)
            window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
        }

        function setupProtection(){const e=e=>{e.preventDefault();alert('Screenshots disabled for security')},t=e=>{if(e.key==='PrintScreen'||e.metaKey&&e.shiftKey&&(e.key==='3'||e.key==='4')){e.preventDefault();alert('Screenshots disabled for security')}};document.addEventListener('contextmenu',e);document.addEventListener('keydown',t)}
        function openLightbox(index){state.lightboxIndex=index;render()}
        function closeLightbox(){state.lightboxIndex=null;render()}
        function nextPhoto(){if(state.lightboxIndex<state.currentAlbum.photos.length-1){state.lightboxIndex++;render()}}
        function prevPhoto(){if(state.lightboxIndex>0){state.lightboxIndex--;render()}}
        function handleFiles(e){const t=Array.from(e.target.files);Promise.all(t.map(e=>new Promise(t=>{const n=new FileReader();n.onload=e=>t(e.target.result);n.readAsDataURL(e)}))).then(e=>{state.photos=[...state.photos,...e];render()})}
        function nav(e){state.view=e;if(e==='home'||e==='upload'||e==='manage'||e==='viewer'){state.photos=[];state.uploaderInfo={name:'',email:''};state.currentAlbum=null;state.isVerified=false;state.viewerOtp='';state.albumIdToView='';state.lightboxIndex=null;state.manageEmail='';window.history.pushState({},document.title,location.pathname)}render()}
        function toggleTerms(checkbox) {
            state.termsAccepted = checkbox.checked;
            render();
        }

        // --- Core Logic Functions (Abridged for brevity) ---
        async function manageAlbum(){
            if(!state.manageEmail){alert('Please enter your email');return}state.loading=true;render();try{const{data:albums,error}=await supabase.from('albums').select('*').eq('email',state.manageEmail.trim().toLowerCase());if(error)throw error;if(!albums||albums.length===0){alert('No albums found with this email address.');state.loading=false;render();return}if(albums.length===1){const album=albums[0];const{data:photos,error:photoError}=await supabase.from('photos').select('*').eq('album_id',album.id).order('created_at',{ascending:true});if(photoError)throw photoError;state.currentAlbum={...album,photos:photos.map(p=>p.photo_data)};state.otp=album.otp;state.otpExpiry=album.otp_expiry;state.shareLink=location.origin+location.pathname+'?album='+album.id;state.view='gallery';state.loading=false;render()}else{state.loading=false;alert('Multiple albums found. Select one:');const albumList=albums.map((a,i)=>`${i+1}. Album ID: ${a.id} (Created: ${new Date(a.created_at).toLocaleDateString()})`).join('\n');const selection=prompt(albumList+'\n\nEnter number (1-'+albums.length+'):');if(selection){const idx=parseInt(selection)-1;if(idx>=0&&idx<albums.length){const album=albums[idx];const{data:photos,error:photoError}=await supabase.from('photos').select('*').eq('album_id',album.id).order('created_at',{ascending:true});if(photoError)throw photoError;state.currentAlbum={...album,photos:photos.map(p=>p.photo_data)};state.otp=album.otp;state.otpExpiry=album.otp_expiry;state.shareLink=location.origin+location.pathname+'?album='+album.id;state.view='gallery';render()}else{alert('Invalid selection')}}}}catch(e){console.error('Manage error:',e);alert('Failed to load albums: '+e.message);state.loading=false;render()}}
        
        async function upload(){
            if (!state.termsAccepted) {
                alert('You must accept the Terms & Conditions before creating an album.');
                return;
            }
            if(!state.uploaderInfo.name||!state.uploaderInfo.email||!state.photos.length){alert('Please fill all required fields and upload at least one photo');return}state.loading=true;render();try{const e=genAlbumId(),t=genOTP(),n=Date.now()+864e5,{data:a,error:o}=await supabase.from('albums').insert({id:e,name:state.uploaderInfo.name,email:state.uploaderInfo.email.trim().toLowerCase(),otp:t,otp_expiry:n,created_at:Date.now()}).select().single();if(o)throw o;const{error:r}=await supabase.from('photos').insert(state.photos.map(t=>({album_id:e,photo_data:t})));if(r)throw r;const{data:s,error:i}=await supabase.from('photos').select('*').eq('album_id',e).order('created_at',{ascending:true});if(i)throw i;state.currentAlbum={...a,photos:s.map(e=>e.photo_data)};state.otp=t;state.otpExpiry=n;state.shareLink=location.origin+location.pathname+'?album='+e;state.view='gallery';state.loading=false;render()}catch(e){console.error('Upload error:',e);alert('Failed to create album: '+e.message);state.loading=false;render()}}

        async function regenOTP(){
            if(!state.currentAlbum)return;state.loading=true;render();try{const e=genOTP(),t=Date.now()+864e5,{error:n}=await supabase.from('albums').update({otp:e,otp_expiry:t}).eq('id',state.currentAlbum.id);if(n)throw n;state.currentAlbum.otp=e;state.otp=e;state.otpExpiry=t;state.loading=false;alert('New OTP generated successfully!');render()}catch(e){console.error('OTP error:',e);alert('Failed to regenerate OTP: '+e.message);state.loading=false;render()}}
        
        async function expireOTP(){
            if(!state.currentAlbum)return;if(!confirm('Expire OTP now? This will immediately block all access to your album.'))return;state.loading=true;render();try{const e=Date.now()-1000,{error:t}=await supabase.from('albums').update({otp_expiry:e}).eq('id',state.currentAlbum.id);if(t)throw t;state.currentAlbum.otp_expiry=e;state.otpExpiry=e;state.loading=false;alert('OTP expired successfully! No one can access this album now.');render()}catch(e){console.error('Expire OTP error:',e);alert('Failed to expire OTP: '+e.message);state.loading=false;render()}}
        
        async function verify(){
            if(!state.albumIdToView||!state.viewerOtp){alert('Please enter both Album ID and OTP');return}state.loading=true;render();try{const{data:e,error:t}=await supabase.from('albums').select('*').eq('id',state.albumIdToView).single();if(t||!e){alert('Album not found. Please check your Album ID.');state.loading=false;render();return}if(Date.now()>e.otp_expiry){alert('OTP has expired. Please contact the album owner to regenerate it.');state.loading=false;render();return}if(e.otp!==state.viewerOtp){alert('Invalid OTP. Please check and try again.');state.loading=false;render();return}const{data:n,error:a}=await supabase.from('photos').select('*').eq('album_id',state.albumIdToView).order('created_at',{ascending:true});if(a)throw a;state.currentAlbum={...e,photos:n.map(e=>e.photo_data)};state.isVerified=true;state.view='view';state.loading=false;setupProtection();render()}catch(e){console.error('Verify error:',e);alert('Failed to verify album: '+e.message);state.loading=false;render()}}
        
        async function delPhoto(e){
            if(!confirm('Are you sure you want to delete this photo?'))return;state.loading=true;render();try{const{data:t,error:n}=await supabase.from('photos').select('id').eq('album_id',state.currentAlbum.id).order('created_at',{ascending:true});if(n)throw n;if(t.length===1){if(confirm('This is the last photo. Delete the entire album?')){await delAlbum();return}else{state.loading=false;render();return}}const a=t[e],{error:o}=await supabase.from('photos').delete().eq('id',a.id);if(o)throw o;state.currentAlbum.photos=state.currentAlbum.photos.filter((t,n)=>n!==e);state.loading=false;alert('Photo deleted successfully');render()}catch(e){console.error('Delete error:',e);alert('Failed to delete photo: '+e.message);state.loading=false;render()}}
        
        async function delAlbum(){
            if(!confirm('Are you sure you want to delete this entire album? This action cannot be undone.'))return;state.loading=true;render();try{const{error:e}=await supabase.from('albums').delete().eq('id',state.currentAlbum.id);if(e)throw e;state.view='home';state.currentAlbum=null;state.loading=false;alert('Album deleted successfully');render()}catch(e){console.error('Delete error:',e);alert('Failed to delete album: '+e.message);state.loading=false;render()}}

        // --- Modular Render Functions (UPDATED) ---

        function renderFooter(){
            // UPDATED: Merged About Amanah story into the footer structure
            return `
                <footer class="bg-gray-900 border-t border-gray-700 text-gray-500 mt-16">
                    <div class="max-w-6xl mx-auto px-4 py-8">
                        <div class="grid md:grid-cols-4 gap-8">
                            
                            <div class="md:col-span-2">
                                <h3 class="text-lg font-bold mb-4 text-purple-400 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    About Amanah
                                </h3>
                                <p class="text-sm text-gray-400 mb-3 leading-relaxed">
                                    Amanah was conceived by **Syed Rashad** out of a genuine need for digital security in sensitive, private matters like matrimonial profile sharing. 
                                    Frustrated by the lack of control and misuse of personal photos, Syed‚Äîdriven by his passion for technology and problem-solving‚Äîdeveloped this platform to offer a controlled, traceable, and protected environment.
                                </p>
                                <p class="text-xs text-gray-500 leading-relaxed">
                                    Syed applies his operational expertise and commitment to excellent customer experience as a **Senior Manager at a WealthTech firm** and advises early-stage startups. Amanah reflects his dedication to secure, efficient digital solutions.
                                </p>
                            </div>
                            
                            <div>
                                <h3 class="text-lg font-bold mb-4 text-purple-400">Legal & Security</h3>
                                <ul class="space-y-2 text-sm">
                                    <li class="text-red-400 font-semibold">‚ö†Ô∏è Cybercrime Warning</li>
                                    <li><a href="#" onclick="nav('terms'); return false;" class="text-purple-300 hover:text-purple-100 underline">Terms & Conditions</a></li>
                                </ul>
                                <p class="text-xs text-gray-500 mt-4 leading-relaxed">
                                    **Disclaimer:** Use at your own risk. The platform owner is not liable for user-uploaded content or misuse.
                                </p>
                            </div>

                            <div>
                                <h3 class="text-lg font-bold mb-4 text-purple-400">Contact</h3>
                                <p class="text-sm text-gray-400 mb-2">Email: help.amanahapp@gmail.com </p>
                                <p class="text-sm text-gray-500 mt-4">¬© 2024 Amanah by Syed Rashad</p>
                            </div>
                        </div>
                        <div class="border-t border-gray-800 mt-6 pt-6 text-center text-xs text-gray-600">ÿ£ŸÖÿßŸÜÿ© - Trustworthy Protection</div>
                    </div>
                </footer>
            `;
        }

        function renderLoading(){
            return '<div class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex flex-col items-center justify-center"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500"></div><span class="mt-4 text-xl font-semibold text-gray-300">Processing secure request...</span></div>';
        }

        function renderHomeView() {
            const actionCard = (title, color, icon, content, buttonText, buttonAction) => `
                <div class="bg-gray-800 rounded-2xl p-6 border border-gray-700 card-shadow transition-all duration-300 hover:border-${color}-500">
                    <div class="flex items-center mb-6">
                        <div class="bg-${color}-900/50 p-3 rounded-xl mr-4 border border-${color}-500/50">
                            <svg class="w-8 h-8 text-${color}-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icon}</svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-100">${title}</h2>
                    </div>
                    <div class="space-y-4 text-gray-400 mb-8">${content}</div>
                    <button onclick="${buttonAction}" class="w-full text-white py-3 rounded-xl font-bold text-lg transition-all duration-300 ${color === 'purple' ? 'btn-gradient-purple' : `bg-${color}-600 hover:bg-${color}-700`}">
                        ${buttonText}
                    </button>
                </div>
            `;
            
            const uploadContent = `
                <p>1. Enter your details and upload photos securely.</p>
                <p>2. Receive a unique Album ID, OTP, and shareable link.</p>
                <p>3. Maintain full control over access and deletion.</p>
            `;
            
            const manageContent = `
                <p>1. Enter the email used during album creation.</p>
                <p>2. Access your security dashboard.</p>
                <p>3. Regenerate OTP, expire access, or delete the album instantly.</p>
            `;

            const viewerContent = `
                <p>1. Enter the Album ID and 6-digit OTP provided by the owner.</p>
                <p>2. View photos instantly on any device.</p>
                <p>3. Access is secured with screenshot protection and a 24-hour expiration.</p>
            `;

            // REMOVED: The verbose 'About Amanah' section has been moved to the footer.

            return `
                <div class="min-h-screen pt-12">
                    <div class="max-w-6xl mx-auto px-4">
                        <div class="text-center mb-16">
                            <svg class="w-16 h-16 text-purple-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                            <h1 class="text-5xl font-extrabold text-white mb-2 tracking-tight">Amanah</h1>
                            <p class="text-xl text-gray-400 mb-6">Secure, Controlled Photo Sharing for Matrimony</p>
                        </div>

                        <div class="grid md:grid-cols-3 gap-8 mb-12">
                            ${actionCard('Upload Photos', 'purple', '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>', uploadContent, 'Start New Upload', 'nav(\'upload\')')}
                            ${actionCard('Manage Access', 'orange', '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>', manageContent, 'Access Management', 'nav(\'manage\')')}
                            ${actionCard('View Album', 'pink', '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>', viewerContent, 'Enter Album ID & OTP', 'nav(\'viewer\')')}
                        </div>
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                            <h3 class="text-xl font-bold text-gray-200 mb-4 flex items-center"><svg class="w-6 h-6 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>Cybercrime Warning</h3>
                            <p class="text-sm text-red-400">Unauthorized morphing, editing, misusing, or distributing photos from this platform is a criminal offense under IT Act 2000 and global cyber laws. Violators will be prosecuted.</p>
                        </div>

                    </div>
                    ${renderFooter()}
                </div>
            `;
        }

        function renderUploadView() {
            // Determine button class based on T&C acceptance
            const buttonClass = state.termsAccepted 
                ? 'btn-gradient-purple shadow-lg' 
                : 'btn-disabled bg-gray-600';

            return `
                <div class="min-h-screen pt-12">
                    <div class="max-w-xl mx-auto px-4">
                        <button onclick="nav('home')" class="mb-6 text-purple-400 hover:text-purple-300 font-semibold flex items-center">‚Üê Back to Home</button>
                        <div class="bg-gray-800 rounded-2xl shadow-xl p-8 border border-gray-700">
                            <h2 class="text-3xl font-bold mb-8 text-center text-purple-400">Secure Photo Upload</h2>
                            
                            <div class="space-y-6">
                                <div>
                                    <label for="uploaderName" class="block text-gray-400 font-semibold mb-2">Your Name <span class="text-red-500">*</span></label>
                                    <input type="text" id="uploaderName" oninput="state.uploaderInfo.name=this.value" value="${state.uploaderInfo.name}" placeholder="Full Name" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label for="uploaderEmail" class="block text-gray-400 font-semibold mb-2">Your Email <span class="text-red-500">*</span></label>
                                    <input type="email" id="uploaderEmail" oninput="state.uploaderInfo.email=this.value" value="${state.uploaderInfo.email}" placeholder="your.email@example.com" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label for="photoUpload" class="block text-gray-400 font-semibold mb-2">Upload Photos <span class="text-red-500">*</span></label>
                                    <input type="file" id="photoUpload" accept="image/*" multiple onchange="handleFiles(event)" class="w-full text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700 cursor-pointer">
                                    ${state.photos.length ? `<p class="mt-2 text-sm text-green-400 font-medium">‚úì ${state.photos.length} photo(s) selected</p>` : `<p class="mt-2 text-sm text-gray-500">Select one or more images</p>`}
                                </div>
                            </div>
                            
                            ${state.photos.length ? `
                            <div class="mt-8 mb-6 border-t border-gray-700 pt-6">
                                <p class="text-lg font-semibold text-gray-300 mb-3">Preview (${state.photos.length}):</p>
                                <div class="grid grid-cols-4 gap-3">
                                    ${state.photos.map((p,idx)=>'<img src="'+p+'" alt="Preview '+idx+'" class="w-full h-16 object-cover rounded-lg border border-gray-600">').join('')}
                                </div>
                            </div>
                            ` : ''}

                            <div class="mt-8 mb-6 flex items-start">
                                <input type="checkbox" id="termsAccept" onchange="toggleTerms(this)" ${state.termsAccepted ? 'checked' : ''} class="mt-1 w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                                <label for="termsAccept" class="ml-3 text-sm font-medium text-gray-300">
                                    I have read and agree to the 
                                    <a href="#" onclick="nav('terms'); return false;" class="text-purple-400 hover:text-purple-300 underline font-semibold">Terms & Conditions</a>
                                    and assume all legal responsibility for the uploaded content.
                                </label>
                            </div>

                            <button onclick="upload()" class="w-full text-white py-4 mt-6 rounded-xl font-bold text-lg ${buttonClass}">
                                Create Album and Get OTP
                            </button>
                        </div>
                    </div>
                    ${renderFooter()}
                </div>
            `;
        }

        function renderManageView() {
            return `
                <div class="min-h-screen pt-12">
                    <div class="max-w-md mx-auto px-4">
                        <button onclick="nav('home')" class="mb-6 text-orange-400 hover:text-orange-300 font-semibold flex items-center">‚Üê Back to Home</button>
                        <div class="bg-gray-800 rounded-2xl shadow-xl p-8 border border-gray-700">
                            <h2 class="text-3xl font-bold mb-8 text-center text-orange-400">Access Album Management</h2>
                            <p class="text-gray-400 mb-6 text-center">Enter the email used to create the album to access controls.</p>
                            
                            <div class="mb-8">
                                <label for="manageEmail" class="block text-gray-400 font-semibold mb-2">Your Email <span class="text-red-500">*</span></label>
                                <input type="email" id="manageEmail" oninput="state.manageEmail=this.value" value="${state.manageEmail}" placeholder="Enter album creation email" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-orange-500">
                            </div>

                            <button onclick="manageAlbum()" class="w-full bg-orange-600 text-white py-4 rounded-xl font-bold text-lg transition-all duration-300 hover:bg-orange-700 shadow-lg">
                                Access Management Dashboard
                            </button>

                            <div class="mt-6 bg-gray-700/50 border-l-4 border-orange-500 p-4 rounded-lg">
                                <p class="text-sm text-gray-300">üí° If you have multiple albums, you will be prompted to select one.</p>
                            </div>
                        </div>
                    </div>
                    ${renderFooter()}
                </div>
            `;
        }

        function renderViewerView() {
            // This is the OTP entry screen. The album content is rendered by renderAlbumView.
            return `
                <div class="min-h-screen pt-12">
                    <div class="max-w-md mx-auto px-4">
                        <button onclick="nav('home')" class="mb-6 text-pink-400 hover:text-pink-300 font-semibold flex items-center">‚Üê Back to Home</button>
                        <div class="bg-gray-800 rounded-2xl shadow-xl p-8 border border-gray-700">
                            <h2 class="text-3xl font-bold mb-8 text-center text-pink-400">Enter Access Credentials</h2>
                            
                            <div class="bg-red-900/50 border-l-4 border-red-500 p-4 mb-6 rounded-lg">
                                <p class="text-xs text-red-300 leading-relaxed"><strong>‚ö†Ô∏è Warning:</strong> This is private content. Unauthorized use or distribution is illegal.</p>
                            </div>
                            
                            <div class="mb-6">
                                <label for="viewerAlbumId" class="block text-gray-400 font-semibold mb-2">Album ID <span class="text-red-500">*</span></label>
                                <input type="text" id="viewerAlbumId" value="${state.albumIdToView}" oninput="state.albumIdToView=this.value.trim()" placeholder="Enter album ID" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 font-mono focus:outline-none focus:ring-2 focus:ring-pink-500">
                            </div>

                            <div class="mb-8">
                                <label for="viewerOtpInput" class="block text-gray-400 font-semibold mb-2">OTP <span class="text-red-500">*</span></label>
                                <input type="text" id="viewerOtpInput" inputmode="numeric" maxlength="6" oninput="state.viewerOtp=this.value.trim()" placeholder="6-digit OTP" class="w-full px-4 py-4 bg-gray-700 border border-gray-600 rounded-lg text-center text-3xl font-mono text-gray-100 focus:outline-none focus:ring-2 focus:ring-pink-500 tracking-widest">
                            </div>

                            <button onclick="verify()" class="w-full bg-pink-600 text-white py-4 rounded-xl font-bold text-lg transition-all duration-300 hover:bg-pink-700 shadow-lg">
                                Access Secure Album
                            </button>
                        </div>
                    </div>
                    ${renderFooter()}
                </div>
            `;
        }
        
        // **UPDATED** - This is the NEWLY simplified viewer screen
        function renderAlbumView() {
            if (!state.currentAlbum) return nav('home'); // Redirect if no album is loaded.
            
            return `
                <div class="min-h-screen pt-12">
                    <div class="max-w-6xl mx-auto px-4">
                        <button onclick="nav('home')" class="mb-6 text-pink-400 hover:text-pink-300 font-semibold flex items-center">‚Üê Exit Album View</button>
                        <div class="bg-gray-800 rounded-2xl shadow-xl p-8 border border-gray-700">
                            <h2 class="text-3xl font-bold mb-4 text-center text-pink-400">Album: ${state.currentAlbum.name}'s Photos</h2>
                            <p class="text-gray-400 mb-8 text-center">Viewing secure, watermarked photos. Screenshot protection is active.</p>
                            
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                ${state.currentAlbum.photos.map((p, idx) => `
                                <div class="relative group cursor-pointer" onclick="openLightbox(${idx})">
                                    <div class="w-full h-40 bg-gray-700 rounded-lg overflow-hidden border-2 border-gray-700 transition-all duration-300 hover:border-pink-500">
                                        <img src="${p}" alt="Album photo ${idx + 1}" class="w-full h-full object-cover">
                                    </div>
                                    <div class="absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-30 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg">
                                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ${renderFooter()}
                </div>
                ${renderLightbox()}
            `;
        }

        // **UPDATED** - This is the Uploader/Manager screen
        function renderGalleryView() {
            if (!state.currentAlbum) return nav('home');
            
            const exp = Date.now() > state.currentAlbum.otp_expiry;
            const otpStatus = exp 
                ? '<span class="text-red-400 font-semibold">EXPIRED</span>' 
                : '<span class="text-green-400 font-semibold">ACTIVE</span> (Expires in: ' + formatTime(state.currentAlbum.otp_expiry) + ')';

            return `
                <div class="min-h-screen pt-12">
                    <div class="max-w-6xl mx-auto px-4">
                        <button onclick="nav('home')" class="mb-6 text-orange-400 hover:text-orange-300 font-semibold flex items-center">‚Üê Back to Home</button>
                        <div class="bg-gray-800 rounded-2xl shadow-xl p-8 border border-gray-700">
                            <h2 class="text-3xl font-bold mb-2 text-center text-orange-400">Album Management Dashboard</h2>
                            <p class="text-xl text-gray-400 mb-8 text-center">Album: ${state.currentAlbum.name} | Status: ${otpStatus}</p>

                            <div class="mb-10 p-6 bg-gray-900 rounded-xl border border-gray-700">
                                <h3 class="text-2xl font-bold text-gray-200 mb-4 flex items-center"><svg class="w-6 h-6 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.882 13.064 9 12.756 9 12c0-.756-.118-1.064-.316-1.342m0 2.684c1.182 2.684 4.015 3.993 6.096 3.993 3.518 0 5.09-2.28 5.09-4.335 0-2.055-1.572-4.335-5.09-4.335-2.081 0-4.914 1.309-6.096 3.993zM12 21c-4.914 0-8.988-3.003-10-7h2c.988 2.003 4.09 4 8 4s7.012-1.997 8-4h2c-1.012 3.997-5.086 7-10 7z"/></svg>Share & Access Control</h3>
                                
                                <div class="space-y-4 mb-6">
                                    <div>
                                        <label for="shareLink" class="block text-sm font-medium text-gray-400 mb-1">Shareable Link</label>
                                        <div class="flex">
                                            <input id="shareLink" type="text" readonly value="${state.shareLink}" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-l-lg text-gray-200 text-sm overflow-hidden truncate copy-input" onclick="copyLink()">
                                            <button onclick="copyLink()" class="flex-shrink-0 px-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-r-lg">Copy Link</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="otpCode" class="block text-sm font-medium text-gray-400 mb-1">One-Time Passcode (OTP)</label>
                                        <div class="flex">
                                            <input id="otpCode" type="text" readonly value="${state.otp}" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-l-lg text-gray-200 text-lg text-center font-mono copy-input" onclick="copyOtp()">
                                            <button onclick="copyOtp()" class="flex-shrink-0 px-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-r-lg">Copy OTP</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                    <button onclick="copyText()" class="w-full btn-gradient-purple text-white py-3 rounded-xl font-bold text-sm shadow-md">
                                        <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5h2M12 7h2m-4 10h4m-4 4h4m-4-8h4"/></svg>
                                        Copy Link & OTP
                                    </button>
                                    <button onclick="shareViaWhatsApp()" class="w-full bg-green-600/80 hover:bg-green-700/80 text-white py-3 rounded-xl font-bold text-sm shadow-md transition-all duration-300">
                                        <svg class="w-5 h-5 inline mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12c0 3.992 2.21 7.275 5.5 8.95L6 22l1.644-4.877C10.613 18.747 11.27 19 12 19c4.97 0 9-4.03 9-9s-4.03-9-9-9zm3.565 11.25c-.27-.134-1.637-.803-1.896-.897-.258-.095-.447-.142-.635.142-.189.284-.732.897-.89 1.086-.157.189-.315.21-.585.074-.27-.134-1.144-.422-2.182-1.34-1.104-.943-1.844-2.488-2.062-2.868-.218-.38-.022-.585.166-.774.17-.168.379-.379.567-.567.188-.188.258-.33.388-.567.13-.236.065-.447-.033-.636-.098-.189-.89-.92-.89-2.122 0-1.203.655-1.76.89-1.76.236 0 .473.007.635.035.16.028.35.065.52.483.17.417.585 1.455.585 1.455 0 .04-.01.077-.02.115-.12.355-.175.76-.145 1.155.03.395.27.774.585 1.086.315.313.684.553 1.08.623.395.07.8.02 1.155-.145.038-.01.077-.02.115-.02.04 0 .077 0 .115.02.348.118 1.155.585 1.455.803.3.218.49.27.76.417.27.147.16 1.065-.01 1.065z"/></svg>
                                        Share via WhatsApp
                                    </button>
                                    <button onclick="regenOTP()" class="w-full bg-orange-600 text-white py-3 rounded-xl font-bold text-sm shadow-md transition-all duration-300 hover:bg-orange-700">
                                        <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356-2A8.964 8.964 0 0012 2a9 9 0 00-6.293 2.707M16 20v-5h.582m-15.356 2A8.964 8.964 0 0112 22a9 9 0 006.293-2.707"/></svg>
                                        Regenerate New OTP
                                    </button>
                                </div>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-200 mb-6 flex items-center"><svg class="w-6 h-6 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4-4m0 0L8 8m4-4v12"/></svg>Manage Photos (${state.currentAlbum.photos.length})</h3>
                            
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                ${state.currentAlbum.photos.map((p, idx) => `
                                <div class="relative group">
                                    <div class="w-full h-36 bg-gray-700 rounded-lg overflow-hidden border-2 border-gray-700 transition-all duration-300 hover:border-orange-500">
                                        <img src="${p}" alt="Album photo ${idx + 1}" class="w-full h-full object-cover cursor-pointer" onclick="openLightbox(${idx})">
                                    </div>
                                    <button onclick="delPhoto(${idx})" class="absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white p-1 rounded-full text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity flex items-center shadow-lg">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    </button>
                                </div>
                                `).join('')}
                            </div>
                            <div class="mt-12 p-6 bg-red-900/30 rounded-xl border border-red-700">
                                <h3 class="text-xl font-bold text-red-400 mb-4 flex items-center"><svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.503-1.637 1.748-3.048L13.82 4.1a2 2 0 00-3.64 0L4.19 16.952c-.755 1.411.218 3.048 1.748 3.048z"/></svg>DANGER ZONE</h3>
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <button onclick="expireOTP()" class="flex-1 w-full bg-yellow-600 hover:bg-yellow-700 text-white py-3 rounded-xl font-bold text-sm shadow-md transition-all duration-300">
                                        <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 0012 9V6m12 6a9 9 0 01-9 9m-6.364-6.364L6 18m3-2l4-4"/></svg>
                                        Expire OTP / Block Access
                                    </button>
                                    <button onclick="delAlbum()" class="flex-1 w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold text-sm shadow-md transition-all duration-300">
                                        <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        Permanently Delete Album
                                    </button>
                                </div>
                            </div>
                            </div>
                    </div>
                    ${renderFooter()}
                </div>
                ${renderLightbox()}
                ${state.loading ? renderLoading() : ''}
            `;
        }

        // **UPDATED** - Added Watermark to Lightbox
        function renderLightbox() {
            if (state.lightboxIndex === null || !state.currentAlbum) return '';
            const photo = state.currentAlbum.photos[state.lightboxIndex];
            const uploaderName = state.currentAlbum.name || 'Amanah';
            const isManaged = state.view === 'gallery'; // Determines if delete option is shown

            return `
                <div class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4" onclick="closeLightbox()">
                    <div class="relative" onclick="event.stopPropagation()"> 
                        <div class="watermark-container">
                            <img src="${photo}" alt="Full Photo ${state.lightboxIndex + 1}" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl">
                            <div class="watermark-overlay">${uploaderName} - PROTECTED</div>
                        </div>

                        <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white text-3xl opacity-70 hover:opacity-100 transition-opacity">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                        
                        ${state.lightboxIndex > 0 ? `<button onclick="prevPhoto()" class="absolute left-4 top-1/2 transform -translate-y-1/2 p-3 bg-gray-800/50 hover:bg-gray-700/80 rounded-full text-white z-20 transition-opacity"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>` : ''}
                        ${state.lightboxIndex < state.currentAlbum.photos.length - 1 ? `<button onclick="nextPhoto()" class="absolute right-4 top-1/2 transform -translate-y-1/2 p-3 bg-gray-800/50 hover:bg-gray-700/80 rounded-full text-white z-20 transition-opacity"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>` : ''}

                        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white bg-black/50 px-4 py-1 rounded-full text-sm font-semibold">
                            ${state.lightboxIndex + 1} / ${state.currentAlbum.photos.length}
                        </div>
                    </div>
                </div>
            `;
        }


        function renderTermsView() {
            // Placeholder for Terms & Conditions view
            return `
                <div class="min-h-screen pt-12">
                    <div class="max-w-4xl mx-auto px-4">
                        <button onclick="nav('upload')" class="mb-6 text-purple-400 hover:text-purple-300 font-semibold flex items-center">‚Üê Back to Upload</button>
                        <div class="bg-gray-800 rounded-2xl shadow-xl p-8 border border-gray-700">
                            <h2 class="text-3xl font-bold mb-6 text-purple-400">Terms & Conditions of Amanah</h2>
                            
                            <div class="space-y-6 text-gray-400 text-sm leading-relaxed">
                                <p class="text-red-400 font-semibold">
                                    By using the Amanah platform for sharing photos, you explicitly agree to the following terms. Failure to comply may result in legal action.
                                </p>
                                
                                <div>
                                    <h3 class="text-lg font-bold text-gray-200 mb-2">1. User Responsibility & Liability</h3>
                                    <p>The **Uploader** (Album Creator) retains full legal responsibility and ownership of all content uploaded. Amanah (Syed Rashad) acts only as a secure intermediary for sharing. The Uploader must ensure they have all necessary permissions to share the photos.</p>
                                </div>

                                <div>
                                    <h3 class="text-lg font-bold text-gray-200 mb-2">2. Cybercrime & Misuse Warning (IT Act 2000)</h3>
                                    <p>Unauthorized morphing, editing, downloading, screenshotting, or distributing of any photo accessed via Amanah is strictly prohibited and constitutes a criminal offense under the Information Technology Act, 2000 (India) and applicable global cyber laws. Violators will be legally prosecuted.</p>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-bold text-gray-200 mb-2">3. Security Features & Limitations</h3>
                                    <p>Amanah implements measures like OTP access, temporary links, and client-side screenshot/context-menu prevention. **However, no digital security measure is absolute.** The platform owner is not liable for data leakage resulting from screen capture on compromised or non-standard devices, user negligence, or unforeseen security breaches.</p>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-bold text-gray-200 mb-2">4. Data Storage & Deletion</h3>
                                    <p>Photos are stored in a secure, private bucket on the Supabase platform. They are intended to be temporary. The Uploader is responsible for deleting the album once it is no longer needed using the 'Manage Access' feature.</p>
                                </div>
                                
                                <p class="text-sm text-gray-500 mt-6">
                                    **Agreement:** Your continued use of the upload or view features signifies your unconditional acceptance of these Terms & Conditions.
                                </p>
                            </div>
                        </div>
                    </div>
                    ${renderFooter()}
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            let content = '';

            // Handle the URL query parameter for direct album viewing
            const urlParams = new URLSearchParams(window.location.search);
            const albumId = urlParams.get('album');
            if (albumId && state.view === 'home' && !state.isVerified) {
                state.albumIdToView = albumId;
                state.view = 'viewer';
            }

            switch (state.view) {
                case 'home':
                    content = renderHomeView();
                    break;
                case 'upload':
                    content = renderUploadView();
                    break;
                case 'manage':
                    content = renderManageView();
                    break;
                case 'viewer':
                    content = renderViewerView();
                    break;
                case 'gallery':
                    // This is the Uploader's management screen
                    content = renderGalleryView();
                    break;
                case 'view':
                    // This is the Verified Viewer's screen (Simplified)
                    content = renderAlbumView(); 
                    break;
                case 'terms':
                    content = renderTermsView();
                    break;
                default:
                    content = renderHomeView();
            }

            app.innerHTML = content;

            if (state.loading) {
                app.innerHTML += renderLoading();
            }
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            render();
        });

        // Set the state for a smooth start (if needed, but 'home' is default)
        // nav('home'); // Redundant if initial render is called on DOMContentLoaded
        
    </script>
</body>
</html>
